default:
  image: python:3.9
  tags: ['docker']
  before_script:
    - python -m pip install --upgrade pip
    - python -m pip install tox

stages:
  - test
  - deploy

run-tests:
  stage: test
  script: 
    - tox

pages:
  stage: deploy
  rules:
    # Execute only on master branch
    - if: $CI_COMMIT_BRANCH == 'master'


  script:
    - tox -e docs
    - mv docs/_build/html public

  artifacts:
    paths:
      - public

publish_pypi:
  stage: deploy
  rules: 
    # Execute only when commit is tagged starting with v followed by a digit
    - if: $CI_COMMIT_TAG =~ /^v\d.*/
  before_script:
    - python -m pip install --upgrade pip
    - python -m pip install tox twine
  script:
    - tox -e clean,build
    - twine check dist/*
    - >
      twine upload
      -u "__token__"
      -p "$PYPI_API_TOKEN"
      dist/* --verbose --skip-existing


