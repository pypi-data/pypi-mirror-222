import{ImageInspectorView}from"../../view/image.mjs";import{isEmpty,isEquivalent,waitFor,humanDuration}from"../../base/helpers.mjs";import{ElementBuilder}from"../../base/builder.mjs";import{Controller}from"../base.mjs";const E=new ElementBuilder({invocationLoading:"enfugue-invocation-loading",invocationLoaded:"enfugue-invocation-loaded",invocationDuration:"enfugue-invocation-duration",invocationIterations:"enfugue-invocation-iterations",invocationRemaining:"enfugue-invocation-remaining",invocationSampleChooser:"enfugue-invocation-sample-chooser",invocationSample:"enfugue-invocation-sample",engineStop:"enfugue-engine-stop"});class InvocationController extends Controller{static truncatePromptLength=36;constructor(e){super(e),this.kwargs={}}get width(){return this.kwargs.width||this.application.config.model.invocation.width}set width(e){this.width!==e&&this.publish("engineWidthChange",e),this.kwargs.width=e}get height(){return this.kwargs.height||this.application.config.model.invocation.height}set height(e){this.height!==e&&this.publish("engineHeightChange",e),this.kwargs.height=e}get size(){return this.kwargs.size||512}set size(e){this.size!==e&&this.publish("engineSizeChange",e),this.kwargs.size=e}get chunkingSize(){return this.kwargs.chunking_size||this.application.config.model.invocation.chunkingSize}set chunkingSize(e){this.chunkingSize!==e&&this.publish("engineChunkingSizeChange",e),this.kwargs.chunking_size=e}get chunkingBlur(){return this.kwargs.chunking_blur||this.application.config.model.invocation.chunkingBlur}set chunkingBlur(e){this.chunkingBlur!==e&&this.publish("engineChunkingBlurChange",e),this.kwargs.chunking_blur=e}get prompt(){return this.kwargs.prompt||""}set prompt(e){this.prompt!==e&&this.publish("enginePromptChange",e),this.kwargs.prompt=e}get negativePrompt(){return this.kwargs.negative_prompt||""}set negativePrompt(e){this.negativePrompt!==e&&this.publish("engineNegativePromptChange",e),this.kwargs.negative_prompt=e}get samples(){return this.kwargs.samples||1}set samples(e){this.samples!==e&&this.publish("engineSamplesChange",e),this.kwargs.samples=e}get seed(){return this.kwargs.seed}set seed(e){this.seed!==e&&this.publish("engineSeedChange",e),this.kwargs.seed=e}get guidanceScale(){return this.kwargs.guidance_scale||this.application.config.model.invocation.guidanceScale}set guidanceScale(e){this.guidanceScale!==e&&this.publish("engineGuidanceScaleChange",e),this.kwargs.guidance_scale=e}get inferenceSteps(){return this.kwargs.num_inference_steps||this.application.config.model.invocation.inferenceSteps}set inferenceSteps(e){this.inferenceSteps!==e&&this.publish("engineInferenceStepsChange",e),this.kwargs.num_inference_steps=e}get model(){return this.kwargs.model}set model(e){this.model!==e&&this.publish("engineModelChange",e),this.kwargs.model=e}get modelType(){return this.kwargs.model_type||"checkpoint"}set modelType(e){this.modelType!==e&&this.publish("engineModelTypeChange",e),this.kwargs.model_type=e}get outscale(){return this.kwargs.outscale||1}set outscale(e){this.outscale!==e&&this.publish("engineOutscaleChange",e),this.kwargs.outscale=parseInt(e)}get upscale(){return this.kwargs.upscale}set upscale(e){isEquivalent(this.upscale,e)||this.publish("engineUpscaleChange",e),this.kwargs.upscale=e}get upscaleIterative(){return!0===this.kwargs.upscale_iterative}set upscaleIterative(e){this.upscaleIterative!==e&&this.publish("engineUpscaleIterativeChange",e),this.kwargs.upscale_iterative=e}get upscaleDiffusion(){return!0===this.kwargs.upscale_diffusion}set upscaleDiffusion(e){this.upscaleDiffusion!==e&&this.publish("engineUpscaleDiffusionChange",e),this.kwargs.upscale_diffusion=e}get upscaleDiffusionPrompt(){return this.kwargs.upscale_diffusion_prompt}set upscaleDiffusionPrompt(e){isEquivalent(this.upscaleDiffusionPrompt,e)||this.publish("engineUpscaleDiffusionPromptChange",e),this.kwargs.upscale_diffusion_prompt=e}get upscaleDiffusionNegativePrompt(){return this.kwargs.upscale_diffusion_negative_prompt}set upscaleDiffusionNegativePrompt(e){isEquivalent(this.upscaleDiffusionNegativePrompt,e)||this.publish("engineUpscaleDiffusionNegativePromptChange",e),this.kwargs.upscale_diffusion_negative_prompt=e}get upscaleDiffusionSteps(){return this.kwargs.upscale_diffusion_steps||this.application.config.model.invocation.upscaleDiffusionSteps}set upscaleDiffusionSteps(e){isEquivalent(this.upscaleDiffusionSteps,e)||this.publish("engineUpscaleDiffusionStepsChange",e),this.kwargs.upscale_diffusion_steps=e}get upscaleDiffusionStrength(){return this.kwargs.upscale_diffusion_strength||this.application.config.model.invocation.upscaleDiffusionStrength}set upscaleDiffusionStrength(e){isEquivalent(this.upscaleDiffusionStrength,e)||this.publish("engineUpscaleDiffusionStrengthChange",e),this.kwargs.upscale_diffusion_strength=e}get upscaleDiffusionGuidanceScale(){return this.kwargs.upscale_diffusion_guidance_scale||this.application.config.model.invocation.upscaleDiffusionGuidanceScale}set upscaleDiffusionGuidanceScale(e){isEquivalent(this.upscaleDiffusionGuidanceScale,e)||this.publish("engineUpscaleDiffusionGuidanceScaleChange",e),this.kwargs.upscale_diffusion_guidance_scale=e}get upscaleDiffusionChunkingSize(){return this.kwargs.upscale_diffusion_chunking_size||this.application.config.model.invocation.upscaleDiffusionChunkingSize}set upscaleDiffusionChunkingSize(e){this.upscaleDiffusionChunkingSize!==e&&this.publish("engineUpscaleDiffusionChunkingSizeChange",e),this.kwargs.upscale_diffusion_chunking_size=e}get upscaleDiffusionChunkingBlur(){return this.kwargs.upscale_diffusion_chunking_blur||this.application.config.model.invocation.upscaleDiffusionChunkingBlur}set upscaleDiffusionChunkingBlur(e){this.upscaleDiffusionChunkingBlur!==e&&this.publish("engineUpscaleDiffusionChunkingBlurChange",e),this.kwargs.upscale_diffusion_chunking_blur=e}get upscaleDiffusionScaleChunkingSize(){return!1!==this.kwargs.upscale_diffusion_scale_chunking_size}set upscaleDiffusionScaleChunkingSize(e){this.upscaleDiffusionScaleChunkingSize!==e&&this.publish("engineUpscaleDiffusionScaleChunkingSizeChange",e),this.kwargs.upscale_diffusion_scale_chunking_size=e}get upscaleDiffusionScaleChunkingBlur(){return!1!==this.kwargs.upscale_diffusion_scale_chunking_blur}set upscaleDiffusionScaleChunkingBlur(e){this.upscaleDiffusionScaleChunkingBlur!==e&&this.publish("engineUpscaleDiffusionScaleChunkingBlurChange",e),this.kwargs.upscale_diffusion_scale_chunking_blur=e}get upscaleDiffusionControlnet(){return this.kwargs.upscale_diffusion_controlnet||null}set upscaleDiffusionControlnet(e){isEquivalent(this.upscaleDiffusionControlnet,e)||this.publish("engineUpscaleDiffusionControlnetChange",e),this.kwargs.upscale_diffusion_controlnet=e}get inversion(){return this.kwargs.inversion||[]}set inversion(e){isEquivalent(this.inversion,e)||this.publish("engineInversionChange",e),this.kwargs.inversion=e}get lora(){return this.kwargs.lora||[]}set lora(e){isEquivalent(this.lora,e)||this.publish("engineLoraChange",e),this.kwargs.lora=e}get lycoris(){return this.kwargs.lycoris||[]}set lycoris(e){isEquivalent(this.lycoris,e)||this.publish("engineLycorisChange",e),this.kwargs.lycoris=e}get refiner(){return this.kwargs.refiner||null}set refiner(e){this.refiner!==e&&this.publish("engineRefinerChange",e),this.kwargs.refiner=e}get refinerSize(){return this.kwargs.refiner_size||null}set refinerSize(e){this.refinerSize!==e&&this.publish("engineRefinerSizeChange",e),this.kwargs.refiner_size=e}get refinerStrength(){return this.kwargs.refiner_strength||.3}set refinerStrength(e){this.refinerStrength!==e&&this.publish("engineRefinerStrengthChange",e),this.kwargs.refiner_strength=e}get refinerGuidanceScale(){return this.kwargs.refiner_guidance_scale||5}set refinerGuidanceScale(e){this.refinerGuidanceScale!==e&&this.publish("engineRefinerGuidanceScaleChange",e),this.kwargs.refiner_guidance_scale=e}get refinerAestheticScore(){return this.kwargs.refiner_aesthetic_score||6}set refinerAestheticScore(e){this.refinerAestheticScore!==e&&this.publish("engineAestheticScoreChange",e),this.kwargs.refiner_aesthetic_score=e}get refinerNegativeAestheticScore(){return this.kwargs.refiner_negative_aesthetic_score||2.5}set refinerNegativeAestheticScore(e){this.refinerNegativeAestheticScore!==e&&this.publish("engineNegativeAestheticScoreChange",e),this.kwargs.refiner_negative_aesthetic_score=e}get inpainter(){return this.kwargs.inpainter||null}set inpainter(e){this.inpainter!==e&&this.publish("engineInpainterChange",e),this.kwargs.inpainter=e}get inpainterSize(){return this.kwargs.inpainter_size||null}set inpainterSize(e){this.inpainterSize!==e&&this.publish("engineInpainterSizeChange",e),this.kwargs.inpainter_size=e}get scheduler(){return this.kwargs.scheduler||null}set scheduler(e){this.scheduler!==e&&this.publish("engineSchedulerChange"),this.kwargs.scheduler=e}get multiScheduler(){return this.kwargs.multi_scheduler||null}set multiScheduler(e){this.multiScheduler!==e&&this.publish("engineMultiDiffusionSchedulerChange"),this.kwargs.multi_scheduler=e}get vae(){return this.kwargs.vae||null}set vae(e){this.vae!==e&&this.publish("engineVaeChange"),this.kwargs.vae=e}async initialize(){this.loadingBar=E.invocationLoading().content(E.invocationLoaded().addClass("sliding-gradient"),E.invocationDuration(),E.invocationIterations(),E.invocationRemaining().hide()),this.invocationSampleChooser=E.invocationSampleChooser().hide(),this.engineStop=E.engineStop().content("Stop Engine").on("click",(()=>{this.stopEngine()})),(await this.images.getNode()).append(this.loadingBar).append(this.invocationSampleChooser),this.application.container.appendChild(await this.engineStop.render()),this.subscribe("engineReady",(()=>{this.enableStop()})),this.subscribe("engineBusy",(()=>{this.enableStop()})),this.subscribe("engineIdle",(()=>{this.disableStop()}))}hideSampleChooser(){this.invocationSampleChooser.hide()}enableStop(){this.engineStop.addClass("ready")}disableStop(){this.engineStop.removeClass("ready")}async invoke(e,i=!1){e=isEmpty(e)?{}:e;let t={...this.kwargs,...e};if(isEmpty(t.prompt))return void this.notify("Error","Missing Prompt","A prompt is required.");let n=await this.application.model.post("invoke",null,null,t);if(this.enableStop(),!isEmpty(n.uuid))if(i){let e=t.prompt.substring(0,this.constructor.truncatePromptLength);e.length===this.constructor.truncatePromptLength&&(e+="..."),await this.startDetachedInvocationMonitor(e,n.uuid,parseInt(t.width)||512,parseInt(t.height)||512)}else await this.canvasInvocation(n.uuid)}async stopEngine(){if(this.engineStop.hasClass("ready")&&await this.confirm("Stop engine and terminate any active invocations?"))try{await this.application.model.post("/invocation/stop"),this.disableStop(),this.notify("info","Stopped","Successfully stopped engine.")}catch(e){let i=`${e}`;isEmpty(e.detail)?isEmpty(e.title)||(i=e.title):i=e.detail,this.notify("error","Error",`Received an error when stopping. The engine may still be stopped, wait a moment and check again. ${i}`)}}async monitorInvocation(e,i,t,n){const s=this.application.config.model.invocation.interval||1e3,a=this.application.config.model.queue.interval||5e3,o=this.application.config.model.invocation.errors.consecutive||2;void 0===i&&(i=()=>{}),void 0===t&&(t=()=>{}),void 0===n&&(n=()=>{});let r,h,u,l,g,c,p=(new Date).getTime(),f=async()=>{let d,m;for(let i=0;i<o;i++)try{d=await this.application.model.get(`/invocation/${e}`)}catch(e){m=e}if(isEmpty(d))return this.notify("error","Invocation Error",`${o} consecutive errors were detected communicating with the server. Please check the server logs. The last error was: ${m}`),void t();if(d.total!==h&&(isEmpty(h)||(p=(new Date).getTime()),h=d.total),d.step!==r&&(r=d.step,g=(new Date).getTime()),d.rate!==u&&(u=d.rate),l=d.duration,!isEmpty(d.images)){let e=d.images.map((e=>`/api/invocation/${e}`)),t="completed"===d.status;i(e,t)}if("error"===d.status)return this.notify("error","Invocation Failed",d.message),void t();if("completed"!==d.status){let e=r/(g-p),i=isEmpty(u)?e:u/1e3,t=(h-r)/(.75*i+.25*e)-((new Date).getTime()-g);isNaN(t)&&(t=1/0),n(t,r,h,u,l),c=setTimeout(f,(e=>"queued"===e.status?a:s)(d))}};f()}async canvasInvocation(e){let i,t,n,s,a,o,r,h,u,l,g=!1,c=!1,p=(new Date).getTime(),f=p,d=p,m=p,w=0,v=[],k=this.loadingBar.find(E.getCustomTag("invocationLoaded")),S=this.loadingBar.find(E.getCustomTag("invocationDuration")),C=this.loadingBar.find(E.getCustomTag("invocationIterations")),_=this.loadingBar.find(E.getCustomTag("invocationRemaining")),b=()=>{if(isEmpty(o))this.invocationSampleChooser.hide();else if(0===v.length){this.images.setCurrentInvocationImage(o[0]),this.invocationSampleChooser.empty().append(E.invocationSample().class("no-sample").content("×").on("click",(()=>{w=null,this.images.hideCurrentInvocation()})));for(let e in o){let i=E.img().src(o[e]);v.push(i),this.invocationSampleChooser.append(E.invocationSample().content(i).on("click",(()=>{this.images.setCurrentInvocationImage(i.src()),w=e})))}this.invocationSampleChooser.show().render()}else{for(let e in o)v[e].src(o[e]);null!==w&&this.images.setCurrentInvocationImage(o[w])}},D=()=>{let e=(new Date).getTime();if(c)s<100&&s>0?s+=1:(s=100,g=!0);else if(!isEmpty(t)&&t<1/0){let o=e-d,r=t-(e-n),h=o+r;a=r,i=h,s=o/h*100}f=e,(()=>{let e=f-p;if(S.content(humanDuration(e/1e3)),isEmpty(s))k.css("width","100%"),C.hide(),_.show().content("Initializing…");else if(s<100){_.show().content(humanDuration(a/1e3)),k.css("width",`${s.toFixed(2)}%`);let e=u,i="it/s";!isEmpty(e)&&e<1/0?(e<1&&(e=1/e,i="s/it"),C.show().content(`Iteration ${r}/${h} (${e.toFixed(2)} ${i})`)):C.show().content(`Iteration ${r}/${h}`)}else if(g||isEmpty(l))k.css("width","0"),_.empty().hide();else{_.content("Finalizing step…");let e=h/l,i="it/s";e<1&&(e=1/e,i="s/it"),C.content(`${h} Iterations at ${e.toFixed(2)} ${i}`),k.css("width","100%")}})(),g||requestAnimationFrame((()=>D()))};this.loadingBar.addClass("loading"),this.images.hideCurrentInvocation(),this.invocationSampleChooser.empty(),window.requestAnimationFrame((()=>D())),this.monitorInvocation(e,(async(e,i)=>{c=i,e.length>0&&(o=e,b())}),(()=>{c=!0,g=!0,_.empty().hide(),C.empty().hide()}),((e,i,a,o,g)=>{t=e,r!==i&&(m=n),r=i,u=o,l=g,n=(new Date).getTime(),h!==a&&(d=n,isEmpty(h)||(r=0,s=null,m=n)),h=a})),await waitFor((()=>g)),this.loadingBar.removeClass("loading")}async startDetachedInvocationMonitor(e,i,t,n){let s=!1,a=[],o=[];this.monitorInvocation(i,(async(r,h,u)=>{s=!0;for(let s in r){let h=r[s];if(a.length<=s){let r=new ImageInspectorView(this.application.config,h,i),u=await this.spawnWindow(`${e}, sample ${s+1}`,r,t+30,n+90);r.loading(),a.push(u),o.push(r)}else o[s].setImage(h),a[s].setName(`${e}, ${u} elapsed, sample ${s+1}`)}if(h)for(let i in a)a[i].setName(`${e} complete in ${u}, sample ${i+1}`),o[i].doneLoading()}),(()=>s=!0)),await waitFor((()=>!0===s))}}export{InvocationController};
