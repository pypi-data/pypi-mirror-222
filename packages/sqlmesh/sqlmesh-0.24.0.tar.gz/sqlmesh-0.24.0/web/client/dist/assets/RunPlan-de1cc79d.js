import{r as m,m as le,D as Q,y as U,H as Se,o as R,R as ce,n as je,p as xe,q as B,X as K,I as Y,s as ve,t as Ee,v as Ne,w as G,x as Ce,T as ke,z as y,A as Ae,B as J,F as De,G as ue,J as ge,K as Me,P as Fe,Q as $,u as S,U as Te,V as $e,W as A,e as L,Y as w,Z as z,$ as Le,j as t,d as j,a0 as X,a1 as W,c as F,S as ye,a2 as _e,a3 as be,a4 as de,a5 as H,a6 as Oe}from"./index-8a3a4b1d.js";import{C as ze,I as me}from"./Input-5e95fd33.js";import{E as k}from"./context-21841b51.js";import{F as Be,P as fe}from"./PlanChangePreview-0d32fe1d.js";import{b as Qe,u as Ue,a as N,x as Ke}from"./Graph-3b138e14.js";import{s as Ve,k as pe}from"./popover-162b4a30.js";import"./context-8d11593f.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-e804284f.js";import"./PlusIcon-362f550c.js";import"./disclosure-5d9b50e6.js";function Ge({title:e,titleId:s,...r},n){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:n,"aria-labelledby":s},r),e?m.createElement("title",{id:s},e):null,m.createElement("path",{fillRule:"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z",clipRule:"evenodd"}))}const He=m.forwardRef(Ge),qe=He;var Je=(e=>(e[e.Open=0]="Open",e[e.Closed=1]="Closed",e))(Je||{}),We=(e=>(e[e.Pointer=0]="Pointer",e[e.Other=1]="Other",e))(We||{}),Ye=(e=>(e[e.OpenMenu=0]="OpenMenu",e[e.CloseMenu=1]="CloseMenu",e[e.GoToItem=2]="GoToItem",e[e.Search=3]="Search",e[e.ClearSearch=4]="ClearSearch",e[e.RegisterItem=5]="RegisterItem",e[e.UnregisterItem=6]="UnregisterItem",e))(Ye||{});function q(e,s=r=>r){let r=e.activeItemIndex!==null?e.items[e.activeItemIndex]:null,n=Me(s(e.items.slice()),d=>d.dataRef.current.domRef.current),i=r?n.indexOf(r):null;return i===-1&&(i=null),{items:n,activeItemIndex:i}}let Xe={1(e){return e.menuState===1?e:{...e,activeItemIndex:null,menuState:1}},0(e){return e.menuState===0?e:{...e,__demoMode:!1,menuState:0}},2:(e,s)=>{var r;let n=q(e),i=Ke(s,{resolveItems:()=>n.items,resolveActiveIndex:()=>n.activeItemIndex,resolveId:d=>d.id,resolveDisabled:d=>d.dataRef.current.disabled});return{...e,...n,searchQuery:"",activeItemIndex:i,activationTrigger:(r=s.trigger)!=null?r:1}},3:(e,s)=>{let r=e.searchQuery!==""?0:1,n=e.searchQuery+s.value.toLowerCase(),i=(e.activeItemIndex!==null?e.items.slice(e.activeItemIndex+r).concat(e.items.slice(0,e.activeItemIndex+r)):e.items).find(l=>{var a;return((a=l.dataRef.current.textValue)==null?void 0:a.startsWith(n))&&!l.dataRef.current.disabled}),d=i?e.items.indexOf(i):-1;return d===-1||d===e.activeItemIndex?{...e,searchQuery:n}:{...e,searchQuery:n,activeItemIndex:d,activationTrigger:1}},4(e){return e.searchQuery===""?e:{...e,searchQuery:"",searchActiveItemIndex:null}},5:(e,s)=>{let r=q(e,n=>[...n,{id:s.id,dataRef:s.dataRef}]);return{...e,...r}},6:(e,s)=>{let r=q(e,n=>{let i=n.findIndex(d=>d.id===s.id);return i!==-1&&n.splice(i,1),n});return{...e,...r,activationTrigger:1}}},Z=m.createContext(null);Z.displayName="MenuContext";function V(e){let s=m.useContext(Z);if(s===null){let r=new Error(`<${e} /> is missing a parent <Menu /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(r,V),r}return s}function Ze(e,s){return xe(s.type,Xe,e,s)}let et=m.Fragment;function tt(e,s){let{__demoMode:r=!1,...n}=e,i=m.useReducer(Ze,{__demoMode:r,menuState:r?0:1,buttonRef:m.createRef(),itemsRef:m.createRef(),items:[],searchQuery:"",activeItemIndex:null,activationTrigger:1}),[{menuState:d,itemsRef:l,buttonRef:a},c]=i,u=U(s);Se([a,l],(I,P)=>{var x;c({type:1}),Ce(P,ke.Loose)||(I.preventDefault(),(x=a.current)==null||x.focus())},d===0);let g=R(()=>{c({type:1})}),f=m.useMemo(()=>({open:d===0,close:g}),[d,g]),p={ref:u};return ce.createElement(Z.Provider,{value:i},ce.createElement(je,{value:xe(d,{0:B.Open,1:B.Closed})},K({ourProps:p,theirProps:n,slot:f,defaultTag:et,name:"Menu"})))}let nt="button";function at(e,s){var r;let n=Y(),{id:i=`headlessui-menu-button-${n}`,...d}=e,[l,a]=V("Menu.Button"),c=U(l.buttonRef,s),u=ve(),g=R(x=>{switch(x.key){case y.Space:case y.Enter:case y.ArrowDown:x.preventDefault(),x.stopPropagation(),a({type:0}),u.nextFrame(()=>a({type:2,focus:N.First}));break;case y.ArrowUp:x.preventDefault(),x.stopPropagation(),a({type:0}),u.nextFrame(()=>a({type:2,focus:N.Last}));break}}),f=R(x=>{switch(x.key){case y.Space:x.preventDefault();break}}),p=R(x=>{if(Ae(x.currentTarget))return x.preventDefault();e.disabled||(l.menuState===0?(a({type:1}),u.nextFrame(()=>{var E;return(E=l.buttonRef.current)==null?void 0:E.focus({preventScroll:!0})})):(x.preventDefault(),a({type:0})))}),I=m.useMemo(()=>({open:l.menuState===0}),[l]),P={ref:c,id:i,type:Ve(e,l.buttonRef),"aria-haspopup":"menu","aria-controls":(r=l.itemsRef.current)==null?void 0:r.id,"aria-expanded":e.disabled?void 0:l.menuState===0,onKeyDown:g,onKeyUp:f,onClick:p};return K({ourProps:P,theirProps:d,slot:I,defaultTag:nt,name:"Menu.Button"})}let st="div",rt=le.RenderStrategy|le.Static;function it(e,s){var r,n;let i=Y(),{id:d=`headlessui-menu-items-${i}`,...l}=e,[a,c]=V("Menu.Items"),u=U(a.itemsRef,s),g=Ee(a.itemsRef),f=ve(),p=Ne(),I=(()=>p!==null?(p&B.Open)===B.Open:a.menuState===0)();m.useEffect(()=>{let o=a.itemsRef.current;o&&a.menuState===0&&o!==(g==null?void 0:g.activeElement)&&o.focus({preventScroll:!0})},[a.menuState,a.itemsRef,g]),Be({container:a.itemsRef.current,enabled:a.menuState===0,accept(o){return o.getAttribute("role")==="menuitem"?NodeFilter.FILTER_REJECT:o.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(o){o.setAttribute("role","none")}});let P=R(o=>{var C,b;switch(f.dispose(),o.key){case y.Space:if(a.searchQuery!=="")return o.preventDefault(),o.stopPropagation(),c({type:3,value:o.key});case y.Enter:if(o.preventDefault(),o.stopPropagation(),c({type:1}),a.activeItemIndex!==null){let{dataRef:v}=a.items[a.activeItemIndex];(b=(C=v.current)==null?void 0:C.domRef.current)==null||b.click()}ge(a.buttonRef.current);break;case y.ArrowDown:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.Next});case y.ArrowUp:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.Previous});case y.Home:case y.PageUp:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.First});case y.End:case y.PageDown:return o.preventDefault(),o.stopPropagation(),c({type:2,focus:N.Last});case y.Escape:o.preventDefault(),o.stopPropagation(),c({type:1}),J().nextFrame(()=>{var v;return(v=a.buttonRef.current)==null?void 0:v.focus({preventScroll:!0})});break;case y.Tab:o.preventDefault(),o.stopPropagation(),c({type:1}),J().nextFrame(()=>{De(a.buttonRef.current,o.shiftKey?ue.Previous:ue.Next)});break;default:o.key.length===1&&(c({type:3,value:o.key}),f.setTimeout(()=>c({type:4}),350));break}}),x=R(o=>{switch(o.key){case y.Space:o.preventDefault();break}}),E=m.useMemo(()=>({open:a.menuState===0}),[a]),D={"aria-activedescendant":a.activeItemIndex===null||(r=a.items[a.activeItemIndex])==null?void 0:r.id,"aria-labelledby":(n=a.buttonRef.current)==null?void 0:n.id,id:d,onKeyDown:P,onKeyUp:x,role:"menu",tabIndex:0,ref:u};return K({ourProps:D,theirProps:l,slot:E,defaultTag:st,features:rt,visible:I,name:"Menu.Items"})}let ot=m.Fragment;function lt(e,s){let r=Y(),{id:n=`headlessui-menu-item-${r}`,disabled:i=!1,...d}=e,[l,a]=V("Menu.Item"),c=l.activeItemIndex!==null?l.items[l.activeItemIndex].id===n:!1,u=m.useRef(null),g=U(s,u);G(()=>{if(l.__demoMode||l.menuState!==0||!c||l.activationTrigger===0)return;let v=J();return v.requestAnimationFrame(()=>{var T,M;(M=(T=u.current)==null?void 0:T.scrollIntoView)==null||M.call(T,{block:"nearest"})}),v.dispose},[l.__demoMode,u,c,l.menuState,l.activationTrigger,l.activeItemIndex]);let f=Qe(u),p=m.useRef({disabled:i,domRef:u,get textValue(){return f()}});G(()=>{p.current.disabled=i},[p,i]),G(()=>(a({type:5,id:n,dataRef:p}),()=>a({type:6,id:n})),[p,n]);let I=R(()=>{a({type:1})}),P=R(v=>{if(i)return v.preventDefault();a({type:1}),ge(l.buttonRef.current)}),x=R(()=>{if(i)return a({type:2,focus:N.Nothing});a({type:2,focus:N.Specific,id:n})}),E=Ue(),D=R(v=>E.update(v)),o=R(v=>{E.wasMoved(v)&&(i||c||a({type:2,focus:N.Specific,id:n,trigger:0}))}),C=R(v=>{E.wasMoved(v)&&(i||c&&a({type:2,focus:N.Nothing}))}),b=m.useMemo(()=>({active:c,disabled:i,close:I}),[c,i,I]);return K({ourProps:{id:n,ref:g,role:"menuitem",tabIndex:i===!0?void 0:-1,"aria-disabled":i===!0?!0:void 0,disabled:void 0,onClick:P,onFocus:x,onPointerEnter:D,onMouseEnter:D,onPointerMove:o,onMouseMove:o,onPointerLeave:C,onMouseLeave:C},theirProps:d,slot:b,defaultTag:ot,name:"Menu.Item"})}let ct=Q(tt),ut=Q(at),dt=Q(it),mt=Q(lt),_=Object.assign(ct,{Button:ut,Items:dt,Item:mt});function Et(){const{errors:e,setIsPlanOpen:s}=Fe(),r=$(h=>h.state),n=$(h=>h.action),i=$(h=>h.setState),d=$(h=>h.setAction),l=$(h=>h.setActivePlan),a=S(h=>h.addConfirmation),c=S(h=>h.setShowConfirmation),u=S(h=>h.environment),g=S(h=>h.environments),f=S(h=>h.setInitialDates),p=S(h=>h.hasSynchronizedEnvironments),[I,P]=m.useState(!1),[x,E]=m.useState(),[D,o]=m.useState(!1),{refetch:C,data:b,isFetching:v}=Te(u.name,{planOptions:{skip_tests:!0,include_unmodified:!0}}),T=m.useCallback($e(C,1e3,!0),[C]);m.useEffect(()=>{D&&(M(),o(!1)),!A(u.isSynchronized)&&T()},[u]),m.useEffect(()=>{var h,te,ne,ae,se,re,ie,oe;b!=null&&(E(b),f(b.start,b.end),P([(h=b.changes)==null?void 0:h.added,(te=b.changes)==null?void 0:te.removed,(ae=(ne=b.changes)==null?void 0:ne.modified)==null?void 0:ae.direct,(re=(se=b.changes)==null?void 0:se.modified)==null?void 0:re.indirect,(oe=(ie=b.changes)==null?void 0:ie.modified)==null?void 0:oe.metadata].some(L)))},[b]);function M(){l(void 0),i(w.Init),d(z.Run),s(!0)}const Pe=e.size>0,we=(A(u.isDefault)||p())&&(A(u.isDefault)||A(u.isInitial)),Re=Le([w.Applying,w.Running,w.Cancelling],r),ee=Pe||v||n!==z.None||r===w.Applying||r===w.Running||r===w.Cancelling;return t.jsxs("div",{className:j("flex items-center",u==null&&"opacity-50 pointer-events-none cursor-not-allowed"),children:[t.jsxs("div",{className:"flex items-center relative",children:[t.jsxs(X,{className:j("mx-0",A(u.isInitial&&u.isDefault)&&"rounded-none rounded-l-lg border-r"),disabled:ee,variant:W.Alternative,size:F.sm,onClick:h=>{h.stopPropagation(),u.isDefault&&A(u.isInitial)?a({headline:"Running Plan Directly On Prod Environment!",description:"Are you sure you want to run your changes directly on prod? Safer choice will be to select or add new environment first.",yesText:`Yes, Run ${u.name}`,noText:"No, Cancel",action(){M()},children:t.jsxs("div",{className:"mt-5 pt-4",children:[t.jsx("h4",{className:"mb-2",children:`${g.size>1?"Select or ":""}Add Environment`}),t.jsxs("div",{className:"flex items-center relative",children:[g.size>1&&t.jsx(he,{className:"mr-2",side:"left",environment:u,showAddEnvironment:!1,onSelect:()=>{o(!0),c(!1)},size:F.md,disabled:v||n!==z.None||r===w.Applying||r===w.Cancelling}),t.jsx(Ie,{className:"w-full",size:F.md,onAdd:()=>{o(!0),c(!1)}})]})]})}):M()},children:[Re&&t.jsx(ye,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"inline-block",children:pt(r,n)})]}),we&&t.jsx(he,{className:"rounded-none rounded-r-lg border-l mx-0",environment:u,disabled:ee})]}),t.jsx(ft,{environment:u,plan:x,isLoading:v,hasChanges:I})]})}function ft({isLoading:e,hasChanges:s,environment:r,plan:n}){var i,d,l,a;return t.jsx("span",{className:"flex align-center h-full w-full",children:t.jsx(t.Fragment,{children:e?t.jsxs("span",{className:"flex items-center ml-2",children:[t.jsx(ye,{className:"w-3 h-3 mr-1"}),t.jsx("span",{className:"inline-block text-xs text-neutral-500",children:"Checking..."})]}):t.jsxs(t.Fragment,{children:[r.isInitial&&r.isLocal&&t.jsx("span",{title:"New",className:"block ml-1 px-2 first-child:ml-0 rounded-full bg-success-10 text-success-500 text-xs text-center font-bold",children:"New"}),[s,e,r.isLocal].every(A)&&t.jsx("span",{title:"Latest",className:"block ml-1 px-2 first-child:ml-0 rounded-full bg-neutral-10 text-xs text-center",children:t.jsx("span",{children:"Latest"})}),L((i=n==null?void 0:n.changes)==null?void 0:i.added)&&t.jsx(O,{headline:"Added Models",type:k.Add,changes:n.changes.added}),L((d=n==null?void 0:n.changes)==null?void 0:d.modified.direct)&&t.jsx(O,{headline:"Direct Changes",type:k.Direct,changes:n.changes.modified.direct.map(({model_name:c})=>c)}),L((l=n==null?void 0:n.changes)==null?void 0:l.modified.indirect)&&t.jsx(O,{headline:"Indirectly Modified",type:k.Indirect,changes:n.changes.modified.indirect.map(c=>c.model_name)}),L((a=n==null?void 0:n.changes)==null?void 0:a.removed)&&t.jsx(O,{headline:"Removed Models",type:k.Remove,changes:n.changes.removed})]})})})}function he({onSelect:e,environment:s,disabled:r,side:n=H.Right,className:i,showAddEnvironment:d=!0,size:l=F.sm}){const a=S(f=>f.environments),c=S(f=>f.setEnvironment),u=S(f=>f.removeLocalEnvironment),g=_e(_.Button);return t.jsx(_,{children:({close:f})=>t.jsxs(t.Fragment,{children:[t.jsxs(g,{variant:W.Alternative,size:l,disabled:r,className:j(i),children:[t.jsx("span",{className:j("block overflow-hidden truncate",(s.isLocal||r)&&"text-neutral-500",s.isSynchronized&&"text-primary-500"),children:s.name}),t.jsx("span",{className:"pointer-events-none inset-y-0 right-0 flex items-center pl-2",children:t.jsx(ze,{className:"h-4 w-4","aria-hidden":"true"})})]}),t.jsx(be,{as:m.Fragment,leave:"transition ease-in duration-100",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:t.jsxs("div",{className:j("absolute top-9 overflow-hidden shadow-xl bg-theme border-2 border-primary-20 rounded-md flex flex-col z-10",n===H.Left&&"left-0",n===H.Right&&"right-0"),children:[t.jsxs(_.Items,{className:"overflow-auto max-h-80 py-2 hover:scrollbar scrollbar--vertical",children:[Array.from(a).map(p=>t.jsx(_.Item,{children:({active:I})=>t.jsxs("div",{onClick:P=>{P.stopPropagation(),c(p),e==null||e()},className:j("flex justify-between items-center px-4 py-1 cursor-pointer overflow-auto",I&&"bg-primary-10",p===s&&"pointer-events-none cursor-default bg-secondary-10"),children:[t.jsxs("div",{className:"flex items-start",children:[t.jsx(qe,{className:j("w-4 h-4 text-primary-500 mt-1",I&&"opacity-10",p!==s&&"opacity-0")}),t.jsxs("span",{className:"block",children:[t.jsxs("span",{className:"flex items-center",children:[t.jsx("span",{className:j("block truncate ml-2",p.isSynchronized&&"text-primary-500"),children:p.name}),t.jsxs("small",{className:"block ml-2",children:["(",p.type,")"]})]}),p.isDefault&&t.jsx("span",{className:"flex ml-2",children:t.jsx("small",{className:"text-xs text-neutral-500",children:"Default Environment"})})]})]}),p.isLocal&&p!==s&&t.jsx(X,{className:"my-0 mx-0",size:F.xs,variant:W.Neutral,onClick:P=>{P.stopPropagation(),u(p)},children:"-"})]})},p.name)),d&&t.jsxs(t.Fragment,{children:[t.jsx(de,{}),t.jsx(Ie,{onAdd:f,className:"mt-2 px-2"})]})]}),t.jsx(de,{})]})})]})})}function Ie({onAdd:e,className:s,label:r="Add",size:n=F.sm}){const i=S(f=>f.getNextEnvironment),d=S(f=>f.isExistingEnvironment),l=S(f=>f.addLocalEnvironment),[a,c]=m.useState(""),[u,g]=m.useState(i().name);return t.jsxs("div",{className:j("flex w-full items-center",s),children:[t.jsx(me,{className:"my-0 mx-0 mr-4 min-w-[10rem] w-full",size:n,children:({className:f})=>t.jsx(me.Textfield,{className:j(f,"w-full"),placeholder:"Environment",value:a,onInput:p=>{p.stopPropagation(),c(p.target.value)}})}),t.jsx(X,{className:"my-0 mx-0 font-bold",size:n,disabled:Oe(a)||d(a),onClick:f=>{f.stopPropagation(),l(a,u),c(""),g(i().name),e==null||e()},children:r})]})}function O({headline:e,type:s,changes:r}){const[n,i]=m.useState(!1);return t.jsx(pe,{onMouseEnter:()=>{i(!0)},onMouseLeave:()=>{i(!1)},className:"relative flex",children:()=>t.jsxs(t.Fragment,{children:[t.jsx("span",{className:j("inline-block ml-1 px-2 rounded-full text-xs font-bold text-neutral-100 cursor-default border border-inherit",s===k.Add&&"bg-success-500 border-success-500",s===k.Remove&&"bg-danger-500 border-danger-500",s===k.Direct&&"bg-secondary-500 border-secondary-500",s===k.Indirect&&"bg-warning-500 border-warning-500",s==="metadata"&&"bg-neutral-500 border-neutral-500"),children:r.length}),t.jsx(be,{show:n,as:m.Fragment,enter:"transition ease-out duration-200",enterFrom:"opacity-0 translate-y-1",enterTo:"opacity-100 translate-y-0",leave:"transition ease-in duration-150",leaveFrom:"opacity-100 translate-y-0",leaveTo:"opacity-0 translate-y-1",children:t.jsx(pe.Panel,{className:"absolute right-1 z-10 mt-8 transform flex p-2 bg-theme-lighter shadow-xl focus:ring-2 ring-opacity-5 rounded-lg ",children:t.jsx(fe,{headline:e,type:s,className:"w-full h-full max-w-[50vw] max-h-[40vh] overflow-hidden overflow-y-auto ",children:t.jsx(fe.Default,{type:s,changes:r})})})})]})})}function pt(e,s){return e===w.Running?"Running Plan...":e===w.Applying?"Applying Plan...":e===w.Cancelling?"Cancelling Plan...":s===z.None?"Run Plan":"Setting Plan..."}export{Et as default};
