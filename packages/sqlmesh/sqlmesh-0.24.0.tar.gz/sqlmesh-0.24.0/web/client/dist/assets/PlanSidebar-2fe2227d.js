import{r as m,D as Fe,aa as Be,I as Me,y as Ie,o as oe,s as ze,R as le,ab as $e,ac as Ue,ad as We,X as Ee,ae as Ge,A as He,z as Pe,j as e,a3 as pe,af as Se,u as K,Q as L,ag as ne,W as C,e as V,i as Ve,Z as c,ah as Re,a1 as G,d as B,Y as A,S as Ae,a0 as te,a6 as ce,$ as ye,c as $,ai as _e,a7 as Le,P as De,U as Qe,aj as qe,V as Ke,ak as ge,al as he,E as ee,a4 as Ce,am as Ye,a8 as Ze,a9 as Xe,an as Je}from"./index-8a3a4b1d.js";import{u as Y,g as es,E as Q,i as ss,a as re,b as be,c as f,P as ls}from"./context-21841b51.js";import{M as ns,H as as,P as W}from"./PlanChangePreview-0d32fe1d.js";import{B as se}from"./Banner-e7e8dfdc.js";import{T as fe}from"./TasksOverview-265003ec.js";import{v as I,M as de,P as ue}from"./disclosure-5d9b50e6.js";import ts from"./ReportErrors-ec12c784.js";import{I as q}from"./Input-5e95fd33.js";import{s as rs}from"./popover-162b4a30.js";import{T as is,p as os}from"./Graph-3b138e14.js";import{S as cs}from"./SplitPane-4ebbd86a.js";import"./context-8d11593f.js";import"./_commonjs-dynamic-modules-302442b1.js";import"./ModelLineage-e804284f.js";import"./PlusIcon-362f550c.js";import"./pluralize-6658fe30.js";let ve=m.createContext(null);ve.displayName="GroupContext";let ds=m.Fragment;function us(l){var s;let[a,t]=m.useState(null),[i,r]=as(),[h,o]=Ge(),b=m.useMemo(()=>({switch:a,setSwitch:t,labelledby:i,describedby:h}),[a,t,i,h]),p={},v=l;return le.createElement(o,{name:"Switch.Description"},le.createElement(r,{name:"Switch.Label",props:{htmlFor:(s=b.switch)==null?void 0:s.id,onClick(u){a&&(u.currentTarget.tagName==="LABEL"&&u.preventDefault(),a.click(),a.focus({preventScroll:!0}))}}},le.createElement(ve.Provider,{value:b},Ee({ourProps:p,theirProps:v,defaultTag:ds,name:"Switch.Group"}))))}let ms="button";function ps(l,s){let a=Me(),{id:t=`headlessui-switch-${a}`,checked:i,defaultChecked:r=!1,onChange:h,name:o,value:b,form:p,...v}=l,u=m.useContext(ve),y=m.useRef(null),E=Ie(y,s,u===null?null:u.setSwitch),[w,g]=is(i,h,r),d=oe(()=>g==null?void 0:g(!w)),N=oe(j=>{if(He(j.currentTarget))return j.preventDefault();j.preventDefault(),d()}),S=oe(j=>{j.key===Pe.Space?(j.preventDefault(),d()):j.key===Pe.Enter&&os(j.currentTarget)}),H=oe(j=>j.preventDefault()),P=m.useMemo(()=>({checked:w}),[w]),_={id:t,ref:E,role:"switch",type:rs(l,y),tabIndex:0,"aria-checked":w,"aria-labelledby":u==null?void 0:u.labelledby,"aria-describedby":u==null?void 0:u.describedby,onClick:N,onKeyUp:S,onKeyPress:H},O=ze();return m.useEffect(()=>{var j;let U=(j=y.current)==null?void 0:j.closest("form");U&&r!==void 0&&O.addEventListener(U,"reset",()=>{g(r)})},[y,g]),le.createElement(le.Fragment,null,o!=null&&w&&le.createElement($e,{features:Ue.Hidden,...We({as:"input",type:"checkbox",hidden:!0,readOnly:!0,form:p,checked:w,name:o,value:b})}),Ee({ourProps:_,theirProps:v,slot:P,defaultTag:ms,name:"Switch"}))}let hs=Fe(ps),fs=us,xe=Object.assign(hs,{Group:fs,Label:ns,Description:Be});function xs({show:l,children:s,afterLeave:a,onClose:t=()=>{}}){return e.jsx(pe,{appear:!0,show:l,as:m.Fragment,afterLeave:a,children:e.jsxs(Se,{as:"div",className:"relative z-[100] w-full h-full ",onClose:t,children:[e.jsx(pe.Child,{as:m.Fragment,enter:"ease-out duration-300",enterFrom:"bg-overlay opacity-0",enterTo:"bg-overlay opacity-80",leave:"ease-in duration-200",leaveFrom:"bg-overlay opacity-80",leaveTo:"bg-overlay opacity-0",children:e.jsx("div",{className:"fixed inset-0"})}),e.jsx("div",{className:"w-full h-full fixed inset-0",children:e.jsx(pe.Child,{as:m.Fragment,enter:"ease-out duration-300",enterFrom:"translate-x-[100%]",enterTo:"translate-x-0",leave:"ease-in duration-200",leaveFrom:"translate-x-0",leaveTo:"translate-x-[100%]",children:s})})]})})}function Te({report:l}){return e.jsxs("div",{children:[e.jsxs("div",{className:"py-2",children:[e.jsxs("p",{children:["Total: ",l.total]}),e.jsxs("p",{children:["Succeeded: ",l.successful]}),e.jsxs("p",{children:["Failed: ",l.failures]}),e.jsxs("p",{children:["Errors: ",l.errors]}),e.jsxs("p",{children:["Dialect: ",l.dialect]})]}),e.jsx("ul",{children:l.details.map(s=>e.jsxs("li",{className:"flex mb-1",children:[e.jsx("span",{className:"inline-block mr-4",children:"â€”"}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("span",{className:"inline-block mb-2",children:s.message}),e.jsx("code",{className:"inline-block max-h-[50vh] bg-theme py-2 px-4 rounded-lg w-full overflow-auto hover:scrollbar scrollbar--vertical scrollbar--horizontal",children:e.jsx("pre",{children:s.details})})]})]},s.message))})]})}function js({setRefTasksOverview:l}){const{backfills:s,hasChanges:a,hasBackfills:t,activeBackfill:i,modified:r,added:h,removed:o,virtualUpdateDescription:b,skip_backfill:p,skip_tests:v,change_categorization:u,hasVirtualUpdate:y,testsReportErrors:E,testsReportMessages:w}=Y(),g=K(x=>x.environment),d=L(x=>x.state),N=L(x=>x.action),S=m.useMemo(()=>Array.from(u.values()).reduce((x,{category:R,change:k})=>{var T;return(T=k==null?void 0:k.indirect)==null||T.forEach(D=>{var z;x[D]==null&&(x[D]=[]),(z=x[D])==null||z.push(R.value!==1)}),R.value===3&&(x[k.model_name]=[!0]),x},{}),[u]),H=m.useCallback(x=>Object.entries(x).reduce((R,[k,T])=>{const D=S[k];return(D!=null?D.every(Boolean):!1)||(R[k]=T),R},{}),[S]),P=m.useCallback(x=>x.reduce((R,k)=>{const T=k.model_name,D=k.interval,z={completed:0,total:k.batches,interval:D,view_name:k.view_name},J=S[T];return(J!=null?J.every(Boolean):!1)||(R[T]=z),R},{}),[S]),_=m.useMemo(()=>(i==null?void 0:i.tasks)!=null?H(i.tasks):P(s),[s,u,i]),O=d===A.Finished,j=[a,t,ne(_)].every(C),U=y&&C(O)||C(j)&&t&&C(p)&&V(Object.keys(_)),Z=es({planAction:N,planState:d,hasBackfills:t,hasVirtualUpdate:y,hasNoChanges:j||Ve(Object.keys(_)),skip_backfill:p});return e.jsx("div",{className:"w-full h-full overflow-hidden overflow-y-auto p-4 hover:scrollbar scrollbar--vertical",children:e.jsx("ul",{className:"w-full",children:N===c.Run?e.jsx(M.StepOptions,{className:"w-full"}):e.jsxs(e.Fragment,{children:[e.jsx(je,{headline:"Tests",description:"Report",disabled:g==null,children:N===c.Running?e.jsx(ie,{hasSpinner:!0,children:"Running Tests ..."}):Re(E)&&Re(w)?e.jsx(ie,{children:v?"Tests Skipped":"No Tests"}):e.jsxs(e.Fragment,{children:[E!=null&&e.jsx(se,{variant:G.Danger,children:ne(E)&&e.jsx(Te,{report:E})}),w!=null&&e.jsx(se,{variant:G.Success,children:ne(w)&&e.jsx("div",{children:w.message})})]})}),e.jsx(je,{headline:"Models",description:"Review Changes",disabled:g==null,children:a?e.jsxs(e.Fragment,{children:[(V(h)||V(o))&&e.jsxs("div",{className:"flex",children:[V(h)&&e.jsx(W,{className:"w-full m-2 max-h-[30vh]",headline:"Added Models",type:Q.Add,children:e.jsx(W.Default,{type:Q.Add,changes:h})}),V(o)&&e.jsx(W,{className:"w-full m-2 max-h-[30vh]",headline:"Removed Models",type:Q.Remove,children:e.jsx(W.Default,{type:Q.Remove,changes:o})})]}),ss(r)&&e.jsxs(e.Fragment,{children:[V(r==null?void 0:r.direct)&&e.jsx(W,{className:"m-2 max-h-[30vh]",headline:"Modified Directly ",type:Q.Direct,children:e.jsx(W.Direct,{changes:r.direct??[]})}),V(r.indirect)&&e.jsx(W,{className:"m-2 max-h-[30vh]",headline:"Modified Indirectly",type:Q.Indirect,children:e.jsx(W.Indirect,{changes:r.indirect??[]})}),V(r==null?void 0:r.metadata)&&e.jsx(W,{className:"m-2 max-h-[30vh]",headline:"Modified Metadata",type:Q.Metadata,children:e.jsx(W.Default,{type:Q.Metadata,changes:(r==null?void 0:r.metadata)??[]})})]})]}):N===c.Running?e.jsx(ie,{hasSpinner:!0,children:"Checking Models..."}):e.jsx(ie,{children:"No Changes"})}),e.jsx(je,{headline:"Backfill",description:"Progress",disabled:g==null,children:e.jsx(I,{defaultOpen:t,children:({open:x})=>e.jsxs(e.Fragment,{children:[e.jsx(ie,{hasSpinner:C(x)&&(N===c.Running||N===c.Applying),children:e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("div",{className:"flex items-center",children:e.jsx("h3",{className:B(d===A.Cancelled&&"text-prose",d===A.Failed&&"text-danger-700",d===A.Finished&&"text-success-700"),children:Z})}),U&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"mr-2 text-sm",children:"Details"}),e.jsx(I.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:x?e.jsx(de,{className:"h-6 w-6 text-primary-500"}):e.jsx(ue,{className:"h-6 w-6 text-primary-500"})})]})]})}),e.jsxs(I.Panel,{className:"px-4 pb-2 text-sm",children:[t&&C(p)&&V(Object.keys(_))&&e.jsx(e.Fragment,{children:e.jsx(m.Suspense,{fallback:e.jsx(Ae,{className:"w-4 h-4 mr-2"}),children:e.jsx(fe,{tasks:_,setRefTasksOverview:l,children:({total:R,completed:k,models:T,completedBatches:D,totalBatches:z})=>e.jsxs(e.Fragment,{children:[e.jsx(fe.Summary,{environment:g.name,planState:d,headline:"Target Environment",completed:k,total:R,completedBatches:D,totalBatches:z,updateType:y?"Virtual":"Backfill",updatedAt:i==null?void 0:i.updated_at}),T!=null&&e.jsx(fe.Details,{models:T,changes:{modified:r,added:h,removed:o},showBatches:t,showVirtualUpdate:y,showProgress:!0})]})})})}),y&&e.jsx("div",{children:e.jsx("small",{className:"text-sm",children:b})})]})]})},Z)})]})})})}function ie({hasSpinner:l=!1,children:s}){return e.jsx("span",{className:"mt-1 mb-4 px-4 py-2 bg-primary-10 flex w-full rounded-lg",children:e.jsxs("span",{className:"flex items-center w-full",children:[l&&e.jsx(Ae,{className:"w-4 h-4 mr-2"}),s]})})}function je({headline:l,description:s,children:a,disabled:t=!1}){return e.jsxs("li",{className:"mb-2 p-4",children:[e.jsx(ys,{className:"min-w-[25%] pr-12",headline:l,disabled:t,children:s}),!t&&a]})}function ys({disabled:l=!1,headline:s,children:a,className:t}){return e.jsxs("div",{className:B(l&&"opacity-40 cursor-not-allowed","mb-4 ",t),children:[s!=null&&e.jsx("h3",{className:"whitespace-nowrap font-bold text-lg",children:s}),a!=null&&e.jsx("small",{className:"whitespace-nowrap",children:a})]})}function gs(){const l=K(a=>a.environment),{testsReportErrors:s}=Y();return e.jsxs("div",{className:"flex flex-col py-2 w-full",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("h4",{className:"text-xl pb-2 px-6",children:[e.jsx("span",{className:"font-bold",children:"Target Environment is"}),e.jsx("b",{className:"ml-2 px-2 py-1 font-sm rounded-md bg-primary-10 text-primary-500",children:l.name})]}),e.jsx("div",{className:"px-6",children:e.jsx(ts,{})})]}),e.jsxs("div",{className:"w-full h-full overflow-auto hover:scrollbar scrollbar--vertical px-6 ",children:[l.isInitial&&l.isDefault&&e.jsx(se,{variant:G.Warning,children:e.jsx(I,{defaultOpen:!0,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(se.Headline,{className:"w-full mr-2 text-sm mb-0",children:"Initializing Prod Environment"}),e.jsx(I.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(de,{className:"h-6 w-6 text-warning-500"}):e.jsx(ue,{className:"h-6 w-6 text-warning-500"})})]}),e.jsx(I.Panel,{className:"px-4 pb-2 text-sm mt-2",children:e.jsx(se.Description,{children:"Prod will be completely backfilled in order to ensure there are no data gaps. After this is applied, it is recommended to validate further changes in a dev environment before deploying to production."})})]})})}),s!=null&&ne(s)&&e.jsx(se,{variant:G.Danger,children:e.jsx(I,{defaultOpen:!1,children:({open:a})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"w-full mr-2 text-sm",children:s==null?void 0:s.title}),e.jsx(I.Button,{className:"flex items-center justify-between rounded-lg text-left text-sm",children:a?e.jsx(de,{className:"h-6 w-6 text-danger-500"}):e.jsx(ue,{className:"h-6 w-6 text-danger-500"})})]}),e.jsx(I.Panel,{className:"px-4 pb-2 text-sm",children:e.jsx(Te,{report:s})})]})})})]})]})}function bs(l=0){return m.useCallback(s=>{setTimeout(()=>{s==null||s.focus()},l)},[l])}function vs({planAction:l,disabled:s,run:a,apply:t,cancel:i,close:r,reset:h}){const{start:o,end:b,hasBackfills:p,skip_tests:v,auto_apply:u,skip_backfill:y,no_gaps:E,no_auto_categorization:w,forward_only:g,restate_models:d,include_unmodified:N,hasVirtualUpdate:S}=Y(),H=K(F=>F.environment),P=bs(),_=l===c.None,O=l===c.Run,j=l===c.Done,U=l===c.Cancelling,Z=l===c.Apply,x=l===c.Applying,R=l===c.Running,k=R||x||U;function T(F){F.stopPropagation(),r()}function D(F){F.stopPropagation(),h()}function z(F){F.stopPropagation(),i()}function J(F){F.stopPropagation(),t()}function ae(F){F.stopPropagation(),a()}const me=p&&C(y);return e.jsxs("div",{className:"flex justify-between px-4 py-2",children:[e.jsxs("div",{className:"flex w-full items-center",children:[(O||R)&&e.jsxs(te,{disabled:R||s,onClick:ae,autoFocus:!0,ref:P,variant:G.Primary,children:[e.jsx("span",{children:re(l,[c.Running,c.Run])}),v&&e.jsx("span",{className:"inline-block ml-1",children:"And Skip Test"}),u&&e.jsx("span",{className:"inline-block ml-1",children:"And Auto Apply"})]}),(Z||x)&&e.jsx(te,{onClick:J,disabled:x||s,ref:P,variant:G.Primary,children:re(l,[c.Applying],me?"Apply And Backfill":S?"Apply Virtual Update":"Apply")}),k&&e.jsx(te,{onClick:z,variant:G.Danger,className:"justify-self-end",disabled:U||s,children:re(l,[c.Cancelling],"Cancel")}),(O||R||Z||x)&&e.jsxs("p",{className:"ml-2 text-xs max-w-sm",children:[e.jsx("span",{children:"Plan for"}),e.jsx("b",{className:"text-primary-500 font-bold mx-1",children:H.name}),e.jsx("span",{className:"inline-block mr-1",children:"environment"}),e.jsxs("span",{className:"inline-block mr-1",children:["from"," ",e.jsx("b",{children:C(ce(o))?o:"the begining of history"})]}),e.jsxs("span",{className:"inline-block mr-1",children:["till ",e.jsx("b",{children:C(ce(o))?b:"today"})]}),E&&e.jsxs("span",{className:"inline-block mr-1",children:["with ",e.jsx("b",{children:"No Gaps"})]}),y&&e.jsxs("span",{className:"inline-block mr-1",children:["without ",e.jsx("b",{children:"Backfills"})]}),g&&e.jsxs("span",{className:"inline-block mr-1",children:["consider as a ",e.jsx("b",{children:"Breaking Change"})]}),w&&e.jsxs("span",{className:"inline-block mr-1",children:["also set ",e.jsx("b",{children:"Change Category"})," manually"]}),C(ce(d))&&e.jsxs("span",{className:"inline-block mr-1",children:["and restate folowing models ",e.jsx("b",{children:d})]}),N&&e.jsx("span",{className:"inline-block mr-1",children:"with views for all models"})]})]}),e.jsxs("div",{className:"flex items-center",children:[(_||[k,O,s,H.isInitial&&H.isDefault,j].every(C))&&e.jsx(te,{onClick:D,variant:G.Neutral,disabled:ye([c.Resetting,c.Running,c.Applying,c.Cancelling],l)||s,children:re(l,[c.Resetting],"Start Over")}),e.jsx(te,{onClick:T,variant:j?G.Primary:G.Neutral,disabled:ye([c.Running,c.Resetting,c.Cancelling],l)||s,ref:j||x?P:void 0,children:re(l,[c.Done],"Close")})]})]})}function ws({label:l,enabled:s,setEnabled:a,a11yTitle:t,size:i=$.md,disabled:r=!1,className:h}){return e.jsxs(xe.Group,{as:"div",className:"flex items-center m-1",children:[e.jsxs(xe,{checked:r?!1:s,onChange:a,className:B("flex relative border-secondary-30 rounded-full m-0","shrink-0 focus:outline-none ring-secondary-300 ring-opacity-60 ring-offset ring-offset-secondary-100 focus:border-secondary-500 focus-visible:ring-opacity-75","transition duration-200 ease-in-out",s?"bg-secondary-500":"bg-secondary-20",h,r?"opacity-50 cursor-not-allowed":"cursor-pointer",i===$.sm&&"h-[14px] w-6 focus:ring-1 border",i===$.md&&"h-5 w-10 focus:ring-2 border-2",i===$.lg&&"h-7 w-14 focus:ring-4 border-2"),disabled:r,children:[e.jsx("span",{className:"sr-only",children:t}),e.jsx("span",{"aria-hidden":"true",className:B("pointer-events-none inline-block transform rounded-full shadow-md transition duration-200 ease-in-out","bg-light",i===$.sm&&"h-3 w-3",i===$.md&&"h-4 w-4",i===$.lg&&"h-6 w-6",s&&i===$.sm&&"translate-x-[10px]",s&&i===$.md&&"translate-x-5",s&&i===$.lg&&"translate-x-7")})]}),l!=null&&e.jsx(xe.Label,{className:B("text-xs font-light ml-1 text-neutral-600 dark:text-neutral-400"),children:l})]})}function X({label:l,info:s,enabled:a,disabled:t=!1,setEnabled:i,className:r}){return e.jsxs("div",{className:B("flex justify-between",r),children:[e.jsxs("label",{className:"block mb-1 px-3 text-sm font-bold",children:[l,e.jsx("small",{className:"block text-xs text-neutral-500",children:s})]}),e.jsx(ws,{disabled:t,enabled:a,setEnabled:i,size:$.lg})]})}function Ns({className:l}){const s=be(),{skip_tests:a,no_gaps:t,skip_backfill:i,forward_only:r,auto_apply:h,no_auto_categorization:o,restate_models:b,isInitialPlanRun:p,create_from:v,include_unmodified:u}=Y(),y=K(g=>g.environment),E=K(g=>g.environments),w=_e.getOnlySynchronized(Array.from(E));return e.jsx("li",{className:B("mt-6 mb-6",l),children:e.jsxs("form",{className:"w-full h-full",children:[e.jsxs("fieldset",{className:B("mb-10 mt-6"),children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1 px-4",children:"Set Dates"}),e.jsx("div",{className:"mt-3",children:e.jsx(M.BackfillDates,{})})]}),e.jsx("fieldset",{className:B("mb-4 mt-6"),children:e.jsx(I,{children:({open:g})=>e.jsxs(e.Fragment,{children:[e.jsxs(I.Button,{className:"flex items-center w-full justify-between rounded-lg text-left text-sm px-4 pt-3 pb-2 bg-neutral-10 hover:bg-theme-darker dark:hover:bg-theme-lighter",children:[e.jsx("h2",{className:"whitespace-nowrap text-xl font-bold mb-1",children:"Additional Options"}),g?e.jsx(de,{className:"h-6 w-6 text-primary-500"}):e.jsx(ue,{className:"h-6 w-6 text-primary-500"})]}),e.jsxs(I.Panel,{className:"px-4 pb-2 text-sm text-neutral-500",children:[e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap",children:[C(y.isDefault)&&e.jsx(q,{className:"w-full",label:"Create From Environment",info:"The environment to base the plan on rather than local files",disabled:w.length<2,children:({className:d,disabled:N})=>e.jsx(q.Selector,{className:B(d,"w-full"),list:_e.getOnlySynchronized(Array.from(E)).map(S=>({value:S.name,text:S.name})),onChange:S=>{s({type:f.PlanOptions,create_from:S})},value:v,disabled:N})}),e.jsx(q,{className:"w-full",label:"Restate Models",info:`Restate data for specified models and models
                        downstream from the one specified. For production
                        environment, all related model versions will have
                        their intervals wiped, but only the current
                        versions will be backfilled. For development
                        environment, only the current model versions will
                        be affected`,children:({className:d})=>e.jsx(q.Textfield,{className:B(d,"w-full"),placeholder:"project.model1, project.model2",disabled:p,value:b??"",onInput:N=>{N.stopPropagation(),s({type:f.PlanOptions,restate_models:N.target.value})}})})]})}),e.jsxs("div",{className:"flex flex-wrap md:flex-nowrap w-full mt-3",children:[e.jsxs("div",{className:"w-full md:mr-2",children:[e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Skip Tests",info:`Skip tests prior to generating the plan if they
                  are defined`,enabled:!!a,setEnabled:d=>{s({type:f.PlanOptions,skip_tests:d})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"No Gaps",info:`Ensure that new snapshots have no data gaps when
                  comparing to existing snapshots for matching
                  models in the target environment`,enabled:!!t,disabled:p,setEnabled:d=>{s({type:f.PlanOptions,no_gaps:d})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Skip Backfill",info:"Skip the backfill step",enabled:!!i,disabled:p,setEnabled:d=>{s({type:f.PlanOptions,skip_backfill:d})}})})]}),e.jsxs("div",{className:"w-full md:ml-2",children:[e.jsxs("div",{className:"block my-2",children:[e.jsx(X,{label:"Include Unmodified",info:"Indicates whether to create views for all models in the target development environment or only for modified ones",enabled:!!u,disabled:p,setEnabled:d=>{s({type:f.PlanOptions,include_unmodified:d})}}),e.jsx(X,{label:"Forward Only",info:"Create a plan for forward-only changes",enabled:!!r,disabled:p,setEnabled:d=>{s({type:f.PlanOptions,forward_only:d})}})]}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"Auto Apply",info:"Automatically apply the plan after it is generated",enabled:!!h,setEnabled:d=>{s({type:f.PlanOptions,auto_apply:d})}})}),e.jsx("div",{className:"block my-2",children:e.jsx(X,{label:"No Auto Categorization",info:"Set category manually",enabled:!!o,disabled:p,setEnabled:d=>{s({type:f.PlanOptions,no_auto_categorization:d})}})})]})]})]})]})})})]})})}function ks({disabled:l=!1}){const s=be(),{start:a,end:t,isInitialPlanRun:i}=Y();return e.jsxs("div",{className:"flex w-full flex-wrap md:flex-nowrap",children:[e.jsx(q,{className:"w-full md:w-[50%]",label:"Start Date (UTC)",info:"The start datetime of the interval",disabled:l||i,children:({disabled:r,className:h})=>e.jsx(q.Textfield,{className:B(h,"w-full"),disabled:r,placeholder:"2023-12-13",value:a,onInput:o=>{o.stopPropagation(),s({type:f.DateStart,start:o.target.value})}})}),e.jsx(q,{className:"w-full md:w-[50%]",label:"End Date (UTC)",info:"The end datetime of the interval",disabled:l||i,children:({disabled:r,className:h})=>e.jsx(q.Textfield,{className:B(h,"w-full"),disabled:r,placeholder:"2022-12-13",value:t,onInput:o=>{o.stopPropagation(),s({type:f.DateEnd,end:o.target.value})}})})]})}function Ps({environment:l,isInitialPlanRun:s}){const{start:a,end:t,skip_tests:i,no_gaps:r,skip_backfill:h,forward_only:o,no_auto_categorization:b,restate_models:p,create_from:v,include_unmodified:u}=Y(),y=m.useMemo(()=>{if(!l.isDefault)return{start:a,end:s&&ce(p)?void 0:t}},[l,a,t,s,p]);return{planOptions:m.useMemo(()=>l.isDefault||l.isInitial?{skip_tests:i,include_unmodified:!0}:{no_gaps:r,skip_backfill:h,forward_only:o,create_from:v,no_auto_categorization:b,skip_tests:i,restate_models:p,include_unmodified:u},[l,r,h,o,u,v,b,i,p]),planDates:y}}function Rs({isInitialPlanRun:l}){const{start:s,end:a,skip_tests:t,no_gaps:i,skip_backfill:r,forward_only:h,include_unmodified:o,no_auto_categorization:b,restate_models:p,hasBackfills:v,create_from:u,change_categorization:y}=Y(),E=m.useMemo(()=>{if(!(l||C(v)))return{start:s,end:a}},[v,s,a,l]),w=m.useMemo(()=>Array.from(y.values()).reduce((g,{category:d,change:N})=>(g[N.model_name]=d.value,g),{}),[y]);return{planDates:E,planOptions:{no_gaps:i,skip_backfill:r,forward_only:h,include_unmodified:o,create_from:u,no_auto_categorization:b,skip_tests:t,restate_models:p},categories:w}}function M({environment:l,isInitialPlanRun:s,initialStartDate:a,initialEndDate:t,disabled:i,onClose:r}){const h=Le(),o=be(),{errors:b,removeError:p,addError:v}=De(),{auto_apply:u,hasChanges:y,hasBackfills:E,hasVirtualUpdate:w,testsReportErrors:g}=Y(),d=L(n=>n.state),N=L(n=>n.action),S=L(n=>n.activePlan),H=L(n=>n.setActivePlan),P=L(n=>n.setAction),_=L(n=>n.setState),O=m.useRef(null),[j,U]=m.useState(!1),Z=Ye(),x=Ps({environment:l,isInitialPlanRun:s}),R=Rs({isInitialPlanRun:s}),{refetch:k}=Qe(l.name,x),{refetch:T}=qe(l.name,R),D=m.useCallback(Ke(k,1e3,!0),[k]);m.useEffect(()=>{const n=Z("tests",z);return l.isInitial&&l.isDefault&&Ne(),o([{type:f.Dates,start:a,end:t}]),()=>{D.cancel(),n==null||n()}},[]),m.useEffect(()=>{o([{type:f.External,isInitialPlanRun:s}]),s&&o([{type:f.PlanOptions,skip_backfill:!1,forward_only:!1,no_auto_categorization:!1,no_gaps:!1,include_unmodified:!0}])},[s]),m.useEffect(()=>{C(j)&&l.isInitial||ye([A.Running,A.Applying,A.Cancelling],d)||(C(j)?P(c.Run):C(y||E)&&C(w)||d===A.Finished?P(c.Done):d===A.Failed?P(c.None):P(c.Apply))},[d,j,y,E,w]),m.useEffect(()=>{S!=null&&o({type:f.BackfillProgress,activeBackfill:S})},[S]),m.useEffect(()=>{b.size!==0&&(H(void 0),_(A.Failed))},[b]);function z(n){o([ge(n.ok)?{type:f.TestsReportMessages,testsReportMessages:n}:{type:f.TestsReportErrors,testsReportErrors:n}])}function J(){U(!1),o([{type:f.ResetBackfills},{type:f.ResetChanges},{type:f.Dates,start:a,end:t},{type:f.ResetPlanOptions}])}function ae(){P(c.Resetting),p(ee.General),J(),_(A.Init),P(c.Run)}function me(){p(ee.General),p(ee.RunPlan),p(ee.ApplyPlan),r()}function F(){o([{type:f.ResetTestsReport}]),_(A.Cancelling),P(c.Cancelling),(N===c.Applying?Xe:Je)(h).then(()=>{P(c.Run),_(A.Cancelled)}).catch(ke=>{he(ke)?console.log("apiCancelPlanApply","Request aborted by React Query"):(console.log("apiCancelPlanApply",ke),ae())})}function we(){P(c.Applying),_(A.Applying),o([{type:f.ResetTestsReport}]),T({throwOnError:!0}).then(({data:n})=>{(n==null?void 0:n.type)===Ze.Virtual&&_(A.Finished)}).catch(n=>{he(n)?console.log("planApply","Request aborted by React Query"):v(ee.ApplyPlan,n)}).finally(()=>{var n;(n=O==null?void 0:O.current)==null||n.scrollIntoView({behavior:"smooth",block:"start"})})}function Ne(){o([{type:f.ResetTestsReport}]),P(c.Running),_(A.Running),D({throwOnError:!0}).then(({data:n})=>{o([{type:f.Backfills,backfills:n==null?void 0:n.backfills},{type:f.Changes,...n==null?void 0:n.changes},{type:f.Dates,start:n==null?void 0:n.start,end:n==null?void 0:n.end}]),U(!0),_(A.Init),u?we():P(c.Run)}).catch(n=>{he(n)?console.log("planRun","Request aborted by React Query"):v(ee.RunPlan,n)})}const Oe=ne(g);return e.jsxs("div",{className:"flex flex-col w-full h-full overflow-hidden pt-6",children:[Oe?e.jsxs(cs,{sizes:ne(g)?[50,50]:[30,70],direction:"vertical",snapOffset:0,className:"flex flex-col w-full h-full overflow-hidden",children:[e.jsx(M.Header,{}),e.jsx(M.Wizard,{setRefTasksOverview:O})]}):e.jsxs(e.Fragment,{children:[e.jsx(M.Header,{}),e.jsx(Ce,{}),e.jsx(M.Wizard,{setRefTasksOverview:O})]}),e.jsx(Ce,{}),e.jsx(M.Actions,{disabled:i,planAction:N,apply:we,run:Ne,cancel:F,close:me,reset:ae})]})}M.Actions=vs;M.Header=gs;M.Wizard=js;M.StepOptions=Ns;M.BackfillDates=ks;const Gs=m.memo(function(){const{isPlanOpen:s,setIsPlanOpen:a}=De(),t=K(u=>u.environment),i=K(u=>u.initialStartDate),r=K(u=>u.initialEndDate),h=L(u=>u.setAction),[o,b]=m.useState(!1);function p(){b(!0)}const v=ge(s)&&C(o);return e.jsx(xs,{show:v,afterLeave:()=>{h(c.None),b(!1),a(!1)},children:e.jsx(Se.Panel,{className:"bg-theme border-8 border-r-0 border-secondary-10 dark:border-primary-10 absolute w-[90%] md:w-[75%] xl:w-[60%] h-full right-0 flex flex-col",children:e.jsx(ls,{children:e.jsx(M,{environment:t,isInitialPlanRun:(t==null?void 0:t.isDefault)==null||ge(t==null?void 0:t.isDefault),disabled:o,initialStartDate:i,initialEndDate:r,onClose:p})})})})});export{Gs as default};
