"use strict";(self.webpackChunkjupyterlab_ipyflow=self.webpackChunkjupyterlab_ipyflow||[]).push([[568],{568:(e,t,l)=>{l.r(t),l.d(t,{default:()=>A});var i=l(350),n=l(850),s=l(919),o=l(761),c=l.n(o);const d="waiting-cell",a="ready-cell",r="ready-making-cell",u="ready-making-input-cell",m="linked-waiting",v="linked-ready-maker",C="ipyflow-slice-self",h="ipyflow-slice-direct",y="ipyflow-slice",f=new Event("cleanup");class g{constructor(){this.comm=null,this.notebook=null,this.session=null,this.isIpyflowCommConnected=!1,this.executionScheduledCells=[],this.selectedCells=[],this.dirtyCells=new Set,this.waitingCells=new Set,this.readyCells=new Set,this.waiterLinks={},this.readyMakerLinks={},this.prevActiveCell=null,this.activeCell=null,this.cellsById={},this.orderIdxById={},this.cellPendingExecution=null,this.isReactivelyExecuting=!1,this.numAltModeExecutes=0,this.altModeExecuteCells=null,this.lastExecutionHighlights=null,this.executedReactiveReadyCells=new Set,this.newReadyCells=new Set,this.forcedReactiveCells=new Set,this.forcedCascadingReactiveCells=new Set,this.numPendingForcedReactiveCounterBumps=0,this.cellParents={},this.cellChildren={},this.settings={}}gatherCellMetadataAndContent(){const e={};return this.notebook.widgets.forEach(((t,l)=>{const i=t.model;e[i.id]={index:l,content:i.sharedModel.getSource(),type:i.type}})),e}requestComputeExecSchedule(){this.comm.send({type:"compute_exec_schedule",cell_metadata_by_id:this.gatherCellMetadataAndContent(),is_reactively_executing:this.isReactivelyExecuting})}executeCells(e){if(0===e.length)return;let t=0;for(const l of e)n.CodeCell.execute(l,this.session).then((l=>{var i,n,s;if("error"===(null===(n=null===(i=l)||void 0===i?void 0:i.content)||void 0===n?void 0:n.status)){t=e.length;for(const t of e)(null===(s=t.promptNode.textContent)||void 0===s?void 0:s.includes("[*]"))&&t.setPrompt("")}else t++;t===e.length&&this.requestComputeExecSchedule()}))}toggleReactivity(){return"reactive"===this.settings.exec_mode?this.settings.exec_mode="normal":"normal"===this.settings.exec_mode&&(this.settings.exec_mode="reactive"),this.session.session.kernel.requestExecute({code:"%flow toggle-reactivity",silent:!0,store_history:!1})}bumpForcedReactiveCounter(){return this.numPendingForcedReactiveCounterBumps--,this.session.session.kernel.requestExecute({code:"%flow bump-min-forced-reactive-counter",silent:!0,store_history:!1})}computeTransitiveClosure(e,t=!0,l=!1){const i=new Set;for(const t of e)w(i,t,l?this.cellParents:this.cellChildren);if(!t)for(const t of e)i.delete(t);return Array.from(i).filter((e=>void 0!==this.cellsById[e])).filter((e=>void 0!==this.orderIdxById[e])).sort(((e,t)=>this.orderIdxById[e]-this.orderIdxById[t])).map((e=>this.cellsById[e]))}}const x={};function p(e){delete x[e]}function w(e,t,l){if(e.has(t))return;e.add(t);const i=l[t];void 0!==i&&i.forEach((t=>w(e,t,l)))}const _={id:"jupyterlab-ipyflow",requires:[s.INotebookTracker,i.ICommandPalette],autoStart:!0,activate:(e,t,l)=>{e.commands.addCommand("alt-mode-execute",{label:"Alt Mode Execute",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>{var l,i;const s=t.currentWidget.sessionContext;if(!s.isReady)return;e.commands.execute("notebook:enter-command-mode");const o=null!==(l=x[s.session.id])&&void 0!==l?l:{},c=o.altModeExecuteCells;if(o.altModeExecuteCells=null,null!==(i=o.isIpyflowCommConnected)&&void 0!==i&&i){if(("batch"===o.settings.reactivity_mode||null===c)&&"code"===t.activeCell.model.type)if(o.numAltModeExecutes++,"incremental"===o.settings.reactivity_mode)1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>n.CodeCell.execute(t.activeCell,s))):n.CodeCell.execute(t.activeCell,s);else if("batch"===o.settings.reactivity_mode){let e=null!=c?c:[t.activeCell];"normal"===o.settings.exec_mode&&null===c&&(e=o.computeTransitiveClosure([t.activeCell.model.id])),1===o.numAltModeExecutes?o.toggleReactivity().done.then((()=>o.executeCells(e))):o.executeCells(e)}else console.error(`Unknown reactivity mode: ${o.settings.reactivity_mode}`)}else n.CodeCell.execute(t.activeCell,s)}}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Accel Shift Enter"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"alt-mode-execute",keys:["Ctrl Shift Enter"],selector:".jp-Notebook"}),l.addItem({command:"alt-mode-execute",category:"execution",args:{}});const i=l=>{var i,n;const s=t.currentWidget.sessionContext;if(!s.isReady)return;const o=null!==(i=x[s.session.id])&&void 0!==i?i:{};if(null===(n=o.isIpyflowCommConnected)||void 0===n||!n)return;e.commands.execute("notebook:enter-command-mode");const c=o.computeTransitiveClosure([o.activeCell.model.id],!0,l);o.numPendingForcedReactiveCounterBumps++,"normal"===o.settings.exec_mode?o.executeCells(c):(o.altModeExecuteCells=c,e.commands.execute("alt-mode-execute"))};e.commands.addCommand("execute-forward-slice",{label:"Execute Forward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>i(!1)}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel J"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-forward-slice",keys:["Accel ArrowDown"],selector:".jp-Notebook"}),e.commands.addCommand("execute-backward-slice",{label:"Execute Backward Slice",isEnabled:()=>!0,isVisible:()=>!0,isToggled:()=>!1,execute:()=>i(!0)}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel K"],selector:".jp-Notebook"}),e.commands.addKeyBinding({command:"execute-backward-slice",keys:["Accel ArrowUp"],selector:".jp-Notebook"});const o=()=>{var e,l;const i=t.currentWidget.sessionContext;if(!i.isReady)return;const n=null!==(e=x[i.session.id])&&void 0!==e?e:{};if(null!==(l=n.isIpyflowCommConnected)&&void 0!==l&&l){let e=n.executionScheduledCells;n.executionScheduledCells=[],0===e.length&&(e=[n.activeCell.model.id]);const t=n.computeTransitiveClosure(e,!1);t.length>0?n.executeCells(t):n.requestComputeExecSchedule()}};s.NotebookActions.executionScheduled.connect(((e,l)=>{var i,n,s;const o=null==t?void 0:t.currentWidget;if((null==o?void 0:o.content)!==l.notebook)return;const c=null==o?void 0:o.sessionContext;if(null===(i=null==c?void 0:c.isReady)||void 0===i||!i)return;const d=null!==(n=x[c.session.id])&&void 0!==n?n:{};if(null===(s=d.isIpyflowCommConnected)||void 0===s||!s)return;const a=d.settings,r="batch"===(null==a?void 0:a.reactivity_mode),u="reactive"===(null==a?void 0:a.exec_mode);r&&u&&"code"===l.cell.model.type&&d.executionScheduledCells.push(l.cell.model.id)})),e.commands.commandExecuted.connect(((e,l)=>{var i,n,s;const c=null==t?void 0:t.currentWidget,d=null==c?void 0:c.sessionContext;if(null===(i=null==d?void 0:d.isReady)||void 0===i||!i)return;const a=null!==(n=x[d.session.id])&&void 0!==n?n:{};if(null===(s=a.isIpyflowCommConnected)||void 0===s||!s)return;const r=a.settings,u="batch"===(null==r?void 0:r.reactivity_mode),m="reactive"===(null==r?void 0:r.exec_mode);if(u)if("notebook:run-cell"===l.id)m?o():a.requestComputeExecSchedule();else if("notebook:run-cell-and-select-next"===l.id){const e=a.activeCell;try{a.activeCell=a.prevActiveCell,m?o():a.requestComputeExecSchedule()}finally{a.activeCell=e}}})),t.widgetAdded.connect(((e,l)=>{const i=l.sessionContext;let n=()=>p(i.session.id);const s=()=>{i.session.kernel.registerCommTarget("ipyflow-client",((e,s)=>{e.onMsg=e=>{var s;const o=e.content.data;(null===(s=o.success)||void 0===s||s)&&("unestablish"===o.type?n():"establish"===o.type&&(n(),n=B(i,t,l.content)))},n(),n=B(i,t,l.content)}))};i.ready.then((()=>{L(l.content),s(),n(),n=B(i,t,l.content),i.kernelChanged.connect(((e,o)=>{null!=o.newValue&&(L(l.content),n(),p(i.session.id),n=()=>p(i.session.id),i.ready.then((()=>{s(),n=B(i,t,l.content)})))}))}))}))}},E=e=>{if(null==e)return null;const t=e.children.item(1);return null===t?null:t.firstElementChild},R=e=>{if(null==e)return null;const t=e.children.item(2);return null===t?null:t.firstElementChild},k=(e,t,l)=>{const i=()=>{e.removeEventListener(t,l),e.removeEventListener("cleanup",i)};e.addEventListener(t,l),e.addEventListener("cleanup",i)},b=(e,t,l,i,n)=>{null!==e&&null!==t&&k(e,l,(()=>{t.firstElementChild.classList[i](n)}))},I=(e,t)=>{b(E(e),R(e),"mouseover","add",m),b(E(e),R(e),"mouseout","remove",m),b(R(e),E(e),"mouseover","add",t),b(R(e),E(e),"mouseout","remove",t)},L=e=>{e.widgets.forEach((e=>{e.node.classList.remove(d),e.node.classList.remove(r),e.node.classList.remove(a),e.node.classList.remove(u),e.node.classList.remove(C),e.node.classList.remove(h),e.node.classList.remove(y);const t=E(e.node);null!==t&&(t.firstElementChild.classList.remove(m),t.firstElementChild.classList.remove(v),t.dispatchEvent(f));const l=R(e.node);null!==l&&(l.firstElementChild.classList.remove(m),l.firstElementChild.classList.remove(v),l.dispatchEvent(f))}))},S=(e,t,l,i,n,s,o)=>{if(null===e)return;const c=()=>{for(const e of t){let t=v;o.has(e)&&(t=m);const n=i(l[e].node);if(null===n||null===n.firstElementChild)return;n.firstElementChild.classList[s](t)}};e.addEventListener(n,c),k(e,n,c)},B=(e,t,l)=>{var i;i=e.session.id,x[i]=new g;const s=x[e.session.id];s.activeCell=l.activeCell;const o=e.session.kernel.createComm("ipyflow","ipyflow");s.comm=o,s.notebook=l,s.session=e;let f=!1;const _=e=>{null!==e&&null!==e.model&&(e.model.isDirty?s.dirtyCells.add(e.model.id):s.dirtyCells.delete(e.model.id))},k=c().debounce((()=>{f?l.model.contentChanged.disconnect(k):(l.widgets.forEach(_),o.send({type:"notify_content_changed",cell_metadata_by_id:s.gatherCellMetadataAndContent()}))}),500),b=(e,t)=>{f?e.stateChanged.disconnect(b):"executionCount"===t.name&&null!==t.newValue&&(s.dirtyCells.delete(e.id),l.widgets.forEach((t=>{t.model.id===e.id&&(t.node.classList.remove(a),t.node.classList.remove(u))})),"incremental"===s.settings.reactivity_mode&&s.requestComputeExecSchedule())};for(const e of l.widgets)e.model.stateChanged.connect(b);const B=(e,t)=>{if(f)l.model.cells.changed.disconnect(B);else if("add"===t.type)for(const e of t.newValues)null==e||e.stateChanged.connect(b);else if("remove"===t.type)for(const e of t.oldValues)null==e||e.stateChanged.disconnect(b)};l.model.cells.changed.connect(B);const A=e=>{let t=-1;l.widgets.forEach(((l,i)=>{l.model.id===e.id&&(t=i)}));const i={type:"change_active_cell",active_cell_id:e.id,active_cell_order_idx:t};o.send(i)},M=(e,t)=>{var i,n;l===e&&(f?l.activeCellChanged.disconnect(M):(A(t.model),s.prevActiveCell=s.activeCell,s.activeCell=t,null!==s.activeCell&&null!==s.activeCell.model&&"code"===s.activeCell.model.type&&(A(s.activeCell.model),s.dirtyCells.has(s.activeCell.model.id)&&(null===(n=(i=s.activeCell.model)._setDirty)||void 0===n||n.call(i,!0)),T(l))))},P=[{action:"mouseover",update:"add"},{action:"mouseout",update:"remove"}],j=(e,t,l,i,n)=>{const o=s.cellsById[e].model;if("code"!==o.type)return;if(null==o.executionCount)return;const c=s.cellsById[e].node;t?c.classList.add(C):c.classList.remove(C),l&&!t?c.classList.add(h):c.classList.remove(h),!i||l||t?c.classList.remove(y):c.classList.add(y),n&&(s.waitingCells.has(e)?(c.classList.add(d),c.classList.add(a),c.classList.remove(u),I(c,m)):s.readyCells.has(e)&&(c.classList.add(u),c.classList.add(a),I(c,v)),"reactive"!==s.settings.exec_mode&&(void 0!==s.waiterLinks[e]&&P.forEach((({action:t,update:l})=>{S(E(c),s.waiterLinks[e],s.cellsById,E,t,l,s.waitingCells),S(R(c),s.waiterLinks[e],s.cellsById,E,t,l,s.waitingCells)})),void 0!==s.readyMakerLinks[e]&&(s.waitingCells.has(e)||(c.classList.add(r),c.classList.add(a)),P.forEach((({action:t,update:l})=>{S(E(c),s.readyMakerLinks[e],s.cellsById,E,t,l,s.waitingCells),S(E(c),s.readyMakerLinks[e],s.cellsById,R,t,l,s.waitingCells)})))))},T=e=>{L(e),(e=>{s.cellsById={},s.orderIdxById={},e.widgets.forEach(((e,t)=>{s.cellsById[e.model.id]=e,s.orderIdxById[e.model.id]=t}))})(e);const t=new Set;let l=new Set,i=s.selectedCells;0===i.length&&(i=[s.activeCell.model.id]);for(const e of i)void 0===s.cellChildren[e]&&void 0===s.cellParents[e]||(l=new Set([e,...l,...s.cellChildren[e],...s.cellParents[e]]),w(t,e,s.cellChildren),t.delete(e),w(t,e,s.cellParents));for(const[e]of Object.entries(s.cellsById))j(e,e===s.activeCell.model.id&&l.has(e),l.has(e),t.has(e),"none"!==s.lastExecutionHighlights)},q=()=>{var e,l,i;f&&t.selectionChanged.disconnect(q);const n=null==t?void 0:t.currentWidget,s=null==n?void 0:n.sessionContext;if(null===(e=null==s?void 0:s.isReady)||void 0===e||!e)return;const o=null!==(l=x[s.session.id])&&void 0!==l?l:{};if(null===(i=o.isIpyflowCommConnected)||void 0===i||!i)return;const c=n.content;o.selectedCells=c.widgets.filter((e=>"code"===e.model.type&&c.isSelected(e))).map((e=>e.model.id)),T(c)};return t.selectionChanged.connect(q),o.onMsg=t=>{var i,c;const d=t.content.data;if(!f&&(null===(i=d.success)||void 0===i||i))if("establish"===d.type)s.isIpyflowCommConnected=!0,l.activeCellChanged.connect(M),l.activeCell.model.stateChanged.connect(b),A(l.activeCell.model),l.model.contentChanged.connect(k),s.requestComputeExecSchedule();else if("set_exec_mode"===d.type)s.numAltModeExecutes=0,s.settings.exec_mode=d.exec_mode;else if("compute_exec_schedule"===d.type){s.settings=d.settings,s.cellParents=d.cell_parents,s.cellChildren=d.cell_children,s.waitingCells=new Set(d.waiting_cells),s.readyCells=new Set(d.ready_cells),0===s.numPendingForcedReactiveCounterBumps?(s.forcedReactiveCells=new Set([...s.forcedReactiveCells,...d.forced_reactive_cells]),s.forcedCascadingReactiveCells=new Set([...s.forcedCascadingReactiveCells,...d.forced_cascading_reactive_cells])):(s.forcedReactiveCells=new Set,s.forcedCascadingReactiveCells=new Set),s.waiterLinks=d.waiter_links,s.readyMakerLinks=d.ready_maker_links,s.cellPendingExecution=null;const t=d.exec_mode;s.isReactivelyExecuting=s.isReactivelyExecuting||null!==(c=null==d?void 0:d.is_reactively_executing)&&void 0!==c&&c||"reactive"===t,s.newReadyCells="reactive"===t?new Set([...s.newReadyCells,...d.new_ready_cells]):new Set;const i=d.flow_order,a=d.exec_schedule;s.lastExecutionHighlights=d.highlights;const r=d.last_executed_cell_id;s.executedReactiveReadyCells.add(r);let u=!1;if(d.last_execution_was_error)u=!0;else if("batch"===s.settings.reactivity_mode){const e=s.computeTransitiveClosure(Array.from(s.forcedCascadingReactiveCells).filter((e=>!s.executedReactiveReadyCells.has(e)))).map((e=>e.model.id));let l;l="reactive"===t?s.computeTransitiveClosure([...s.newReadyCells,...s.forcedReactiveCells,...e].filter((e=>!s.executedReactiveReadyCells.has(e)))).filter((e=>!s.executedReactiveReadyCells.has(e.model.id))):[...s.forcedReactiveCells,...e].filter((e=>!s.executedReactiveReadyCells.has(e)&&void 0!==s.cellsById[e]&&void 0!==s.orderIdxById[e])).sort(((e,t)=>s.orderIdxById[e]-s.orderIdxById[t])).map((e=>s.cellsById[e])),0===l.length?u=!0:(s.isReactivelyExecuting=!0,s.executedReactiveReadyCells=new Set([...s.executedReactiveReadyCells,...l.map((e=>e.model.id))]),s.executeCells(l))}else if("incremental"===s.settings.reactivity_mode){let o=!1;for(const e of l.widgets){if(!o&&(o=e.model.id===r,"in_order"===i||"strict"===a))continue;if("code"!==e.model.type||s.executedReactiveReadyCells.has(e.model.id))continue;if(!(s.forcedReactiveCells.has(e.model.id)||s.newReadyCells.has(e.model.id)&&"reactive"===t))continue;const l=e;if(null===s.cellPendingExecution){if(s.cellPendingExecution=l,"in_order"===i||"strict"===a)break}else null==l.model.executionCount||l.model.executionCount<s.cellPendingExecution.model.executionCount&&(s.cellPendingExecution=l)}null===s.cellPendingExecution?u=!0:(s.isReactivelyExecuting=!0,n.CodeCell.execute(s.cellPendingExecution,e))}u&&(s.isReactivelyExecuting&&("reactive"===s.lastExecutionHighlights&&(s.readyCells=s.executedReactiveReadyCells),o.send({type:"reactivity_cleanup"})),s.numAltModeExecutes>0&&0==--s.numAltModeExecutes&&s.toggleReactivity(),s.numPendingForcedReactiveCounterBumps>0&&s.bumpForcedReactiveCounter(),s.forcedReactiveCells=new Set,s.forcedCascadingReactiveCells=new Set,s.newReadyCells=new Set,s.executedReactiveReadyCells=new Set,s.isReactivelyExecuting=!1,T(l))}},o.open({interface:"jupyterlab"}),()=>{o.dispose(),f=!0,s.isIpyflowCommConnected=!1,p(e.session.id)}},A=_}}]);