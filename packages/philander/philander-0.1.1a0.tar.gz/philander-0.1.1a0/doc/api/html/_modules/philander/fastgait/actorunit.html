
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>philander.fastgait.actorunit &#8212; philander 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for philander.fastgait.actorunit</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;A module to provide base classes and data types for the FastGait ActorUnit driver implementations.</span>

<span class="sd">In case of FOG, the ActorUnit is alerted via BlueTooth and starts</span>
<span class="sd">vibrating in pulses, giving the patient a haptic cueing impulse.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Oliver Maye&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Event&quot;</span><span class="p">,</span> <span class="s2">&quot;ConnectionState&quot;</span><span class="p">,</span> <span class="s2">&quot;ActorUnit&quot;</span><span class="p">,]</span>
<span class="kn">from</span> <span class="nn">interruptable</span> <span class="kn">import</span> <span class="n">Interruptable</span>
<span class="kn">from</span> <span class="nn">module</span> <span class="kn">import</span> <span class="n">Module</span>
<span class="kn">from</span> <span class="nn">systypes</span> <span class="kn">import</span> <span class="n">ErrorCode</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">auto</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">bleak</span> <span class="kn">import</span> <span class="n">BleakClient</span><span class="p">,</span> <span class="n">BleakScanner</span>
<span class="kn">from</span> <span class="nn">bleak.exc</span> <span class="kn">import</span> <span class="n">BleakDBusError</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span><span class="p">,</span> <span class="n">Lock</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>

<div class="viewcode-block" id="Event"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.Event">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span> <span class="n">Enum</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data class to represent events, that the ActorUnit emits or handles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cueStandard</span>    <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">cueStop</span>        <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">bleDiscovering</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">bleConnected</span>   <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">bleDisconnected</span><span class="o">=</span> <span class="n">auto</span><span class="p">()</span>

    <span class="n">toStr</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">bleDiscovering</span>  <span class="p">:</span> <span class="s1">&#39;ActorUnit.discovering&#39;</span><span class="p">,</span>
        <span class="n">bleConnected</span>    <span class="p">:</span> <span class="s1">&#39;ActorUnit.connected&#39;</span><span class="p">,</span>
        <span class="n">bleDisconnected</span> <span class="p">:</span> <span class="s1">&#39;ActorUnit.disconnected&#39;</span><span class="p">,</span>
    <span class="p">}</span></div>
    
<div class="viewcode-block" id="ConnectionState"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ConnectionState">[docs]</a><span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">ConnectionState</span><span class="p">(</span> <span class="n">Enum</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Data class to represent BLE connection states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">disconnected</span> <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">discovering</span>  <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    <span class="n">connected</span>    <span class="o">=</span> <span class="n">auto</span><span class="p">()</span>
    
    <span class="n">toStr</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">disconnected</span> <span class="p">:</span> <span class="s1">&#39;Disconnected&#39;</span><span class="p">,</span>
        <span class="n">discovering</span>  <span class="p">:</span> <span class="s1">&#39;Discovering&#39;</span><span class="p">,</span>
        <span class="n">connected</span>    <span class="p">:</span> <span class="s1">&#39;Connected&#39;</span><span class="p">,</span>
    <span class="p">}</span></div>
        
    
<div class="viewcode-block" id="ActorUnit"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit">[docs]</a><span class="k">class</span> <span class="nc">ActorUnit</span><span class="p">(</span> <span class="n">Module</span><span class="p">,</span> <span class="n">Interruptable</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of the vibration belt driver, also called ActorUnit.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Public attributes</span>
    <span class="c1">#</span>
    
    <span class="n">MOTORS_1</span> <span class="o">=</span> <span class="mi">1</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;First actuator&quot;&quot;&quot;</span>
    <span class="n">MOTORS_2</span> <span class="o">=</span> <span class="mi">2</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Second actuator&quot;&quot;&quot;</span>
    <span class="n">MOTORS_NONE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mnemonics for no actuator&quot;&quot;&quot;</span>
    <span class="n">MOTORS_ALL</span>  <span class="o">=</span> <span class="n">MOTORS_1</span> <span class="o">|</span> <span class="n">MOTORS_2</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mnemonics for all actuators&quot;&quot;&quot;</span>
    
    
    <span class="c1">#</span>
    <span class="c1"># Pulses are emitted periodically in rectangle form and the low-level</span>
    <span class="c1"># API allows to configure:</span>
    <span class="c1">#   - the length of one period,</span>
    <span class="c1">#   - the length of the on-part,</span>
    <span class="c1">#   - an initial delay and</span>
    <span class="c1">#   - the number of periods to run.</span>
    <span class="c1">#</span>
    <span class="c1">#            |&lt; PULSE ON &gt;|</span>
    <span class="c1">#            _____________       _____________       ______     ON</span>
    <span class="c1"># ...........|            |______|            |______|     ...  OFF</span>
    <span class="c1">#</span>
    <span class="c1">#|&lt;  DELAY  &gt;|&lt;   PULSE PERIOD  &gt;|</span>
    <span class="c1">#</span>
    
    <span class="n">DELAY_DEFAULT</span>           <span class="o">=</span> <span class="mi">0</span>     <span class="c1"># immediately</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delay of the first pulse, given in milliseconds 0...65535 (0xFFFF). Zero (0) to start cueing immediately.&quot;&quot;&quot;</span>
    <span class="n">PULSE_PERIOD_DEFAULT</span>    <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># ms</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pulse period in milliseconds 0...65535 (0xFFFF).&quot;&quot;&quot;</span>
    <span class="n">PULSE_ON_DEFAULT</span>        <span class="o">=</span> <span class="mi">120</span>   <span class="c1"># ms; 60% duty cycle</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pulse ON duration in milliseconds 0...65535 (0xFFFF). Must be less than the period.&quot;&quot;&quot;</span>
    <span class="n">PULSE_COUNT_DEFAULT</span>     <span class="o">=</span> <span class="mi">3</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Total number of pulses 0...255. Zero (0) means infinitely.&quot;&quot;&quot;</span>
    <span class="n">PULSE_INTENSITY_DEFAULT</span> <span class="o">=</span> <span class="mi">80</span>    <span class="c1"># 80% strength</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Intensity of the ON phase vibration [0...100].&quot;&quot;&quot;</span>
    <span class="n">ACTUATORS_DEFAULT</span>       <span class="o">=</span> <span class="n">MOTORS_ALL</span> <span class="c1"># All motors</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Motor selection used for vibration [0...3]: Motors #1, or #2 or both.&quot;&quot;&quot;</span>

    <span class="c1"># BLE defaults</span>
    <span class="n">BLE_DEVICE_UUID</span>         <span class="o">=</span> <span class="s1">&#39;0000fa01-0000-1000-8000-00805f9b34fb&#39;</span>
    <span class="n">BLE_CHARACTERISTIC_UUID</span> <span class="o">=</span> <span class="s1">&#39;0000fa61-0000-1000-8000-00805f9b34fb&#39;</span>
    <span class="n">BLE_DISCOVERY_TIMEOUT</span>   <span class="o">=</span> <span class="mf">5.0</span>   <span class="c1"># in seconds</span>
    
    <span class="c1">#</span>
    <span class="c1"># Private attributes</span>
    <span class="c1">#</span>
    
    <span class="n">_CMD_START</span>         <span class="o">=</span> <span class="mh">0x01</span>
    <span class="n">_CMD_STOP</span>          <span class="o">=</span> <span class="mh">0x02</span>
    <span class="n">_CMD_SET_DEFAULT</span>   <span class="o">=</span> <span class="mh">0x03</span>
    <span class="n">_CMD_GET_DEFAULT</span>   <span class="o">=</span> <span class="mh">0x04</span>
    <span class="n">_CMD_START_DEFAULT</span> <span class="o">=</span> <span class="mh">0x05</span>
    
    <span class="n">_TIMER_KEEP</span>  <span class="o">=</span> <span class="mh">0x00</span>
    <span class="n">_TIMER_RESET</span> <span class="o">=</span> <span class="mh">0x01</span>
    
    <span class="c1">#</span>
    <span class="c1"># Module API</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># Create instance attributes</span>
        <span class="n">defDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ActorUnit</span><span class="o">.</span><span class="n">Params_init</span><span class="p">(</span><span class="n">defDict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">defDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.delay&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulsePeriod</span> <span class="o">=</span> <span class="n">defDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulsePeriod&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulseOn</span> <span class="o">=</span> <span class="n">defDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseOn&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulseCount</span> <span class="o">=</span> <span class="n">defDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseCount&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulseIntensity</span> <span class="o">=</span> <span class="n">defDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseIntensity&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actuators</span> <span class="o">=</span> <span class="n">defDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.actuators&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bleDiscoveryTimeout</span> <span class="o">=</span> <span class="n">defDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.BLE.discovery.timeout&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdStart</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="n">ActorUnit</span><span class="o">.</span><span class="n">_CMD_START_DEFAULT</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmdStop</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">([</span><span class="n">ActorUnit</span><span class="o">.</span><span class="n">_CMD_STOP</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleClient</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleChar</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">=</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleLock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ActorUnit.Params_init"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.Params_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">Params_init</span><span class="p">(</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">paramDict</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize parameters with their defaults.</span>
<span class="sd">        </span>
<span class="sd">        The following settings are supported:</span>
<span class="sd">        </span>
<span class="sd">        ===============================    ==========================================================================================================</span>
<span class="sd">        Key name                           Value type, meaning and default</span>
<span class="sd">        ===============================    ==========================================================================================================</span>
<span class="sd">        ActorUnit.delay                    ``int`` [0...65535] Initial delay in ms; :attr:`DELAY_DEFAULT`</span>
<span class="sd">        ActorUnit.pulsePeriod              ``int`` [0...65535] Length of one period in ms; :attr:`PULSE_PERIOD_DEFAULT`</span>
<span class="sd">        ActorUnit.pulseOn                  ``int`` [0...pulsePeriod] Length of the active part in that period in ms; :attr:`PULSE_ON_DEFAULT`</span>
<span class="sd">        ActorUnit.pulseCount               ``int`` [0...255] Number of pulses. Zero (0) means infinite pulses. :attr:`PULSE_COUNT_DEFAULT`</span>
<span class="sd">        ActorUnit.pulseIntensity           ``int`` [0...100] Intensity of the pulses given as a percentage %. :attr:`PULSE_INTENSITY_DEFAULT`</span>
<span class="sd">        ActorUnit.actuators                Motors to be used for the pulses [0...3] meaning none, left, right, both motors; :attr:`ACTUATORS_DEFAULT`</span>
<span class="sd">        ActorUnit.BLE.discovery.timeout    ``int`` or ``float`` Timeout for the BLE discovery phase, given in seconds. :attr:`BLE_DISCOVERY_TIMEOUT`</span>
<span class="sd">        ActorUnit.BLE.callback             Callback routine to be executed on the change of the BLE connection status. No default.</span>
<span class="sd">        ===============================    ==========================================================================================================</span>

<span class="sd">        Also see: :meth:`.Module.Params_init`.</span>
<span class="sd">        </span>
<span class="sd">        :param dict(str, object) paramDict: The configuration dictionary.</span>
<span class="sd">        :returns: none</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ActorUnit.delay&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.delay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">DELAY_DEFAULT</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ActorUnit.pulsePeriod&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulsePeriod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">PULSE_PERIOD_DEFAULT</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ActorUnit.pulseOn&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseOn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">PULSE_ON_DEFAULT</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ActorUnit.pulseCount&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">PULSE_COUNT_DEFAULT</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ActorUnit.pulseIntensity&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseIntensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">PULSE_INTENSITY_DEFAULT</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ActorUnit.actuators&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.actuators&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">ACTUATORS_DEFAULT</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ActorUnit.BLE.discovery.timeout&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.BLE.discovery.timeout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">BLE_DISCOVERY_TIMEOUT</span>
        <span class="k">return</span> <span class="kc">None</span></div>
    
<div class="viewcode-block" id="ActorUnit.open"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">paramDict</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an instance and prepare it for use.</span>

<span class="sd">        Also see: :meth:`.Module.open`.</span>
<span class="sd">        </span>
<span class="sd">        :param dict(str, object) paramDict: Configuration parameters as\</span>
<span class="sd">        possibly obtained from :meth:`Params_init`.</span>
<span class="sd">        :return: An error code indicating either success or the reason of failure.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.delay&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.delay&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span><span class="o">&lt;=</span><span class="mh">0xFFFF</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.pulsePeriod&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulsePeriod&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span><span class="o">&lt;=</span><span class="mh">0xFFFF</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pulsePeriod</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.pulseOn&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseOn&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulsePeriod</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pulseOn</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.pulseCount&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseCount&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span><span class="o">&lt;=</span><span class="mh">0xFF</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pulseCount</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.pulseIntensity&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.pulseIntensity&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span><span class="o">&lt;=</span><span class="mi">100</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pulseIntensity</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.actuators&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.actuators&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;=</span><span class="n">ActorUnit</span><span class="o">.</span><span class="n">MOTORS_NONE</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span><span class="o">&lt;=</span><span class="n">ActorUnit</span><span class="o">.</span><span class="n">MOTORS_ALL</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actuators</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.BLE.discovery.timeout&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.BLE.discovery.timeout&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bleDiscoveryTimeout</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="s2">&quot;ActorUnit.BLE.callback&quot;</span> <span class="ow">in</span> <span class="n">paramDict</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">paramDict</span><span class="p">[</span><span class="s2">&quot;ActorUnit.BLE.callback&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bleCallback</span> <span class="o">=</span> <span class="n">val</span>
    
        <span class="c1"># Create start-cueing-command buffer</span>
        <span class="c1"># self.cmdStart[0] = ActorUnit._CMD_START</span>
        <span class="c1"># self.cmdStart[1] = self.pulseOn &amp; 0xFF</span>
        <span class="c1"># self.cmdStart[2] = self.pulseOn &gt;&gt; 8</span>
        <span class="c1"># self.cmdStart[3] = self.pulsePeriod &amp; 0xFF</span>
        <span class="c1"># self.cmdStart[4] = self.pulsePeriod &gt;&gt; 8</span>
        <span class="c1"># self.cmdStart[5] = self.delay &amp; 0xFF</span>
        <span class="c1"># self.cmdStart[6] = self.delay &gt;&gt; 8</span>
        <span class="c1"># self.cmdStart[7] = self.pulseCount</span>
        <span class="c1"># self.cmdStart[8] = self.pulseIntensity</span>
        <span class="c1"># self.cmdStart[9] = self.actuators</span>
        <span class="c1"># self.cmdStart[10] = ActorUnit._TIMER_RESET</span>
        
        <span class="c1">#self.couple()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="ActorUnit.close"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shuts down the instance safely.</span>

<span class="sd">        Also see: :meth:`.Module.close`.</span>
<span class="sd">        </span>
<span class="sd">        :return: An error code indicating either success or the reason of failure.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isCoupled</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decouple</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span> <span class="o">=</span> <span class="kc">None</span></div>
    
    <span class="c1">#</span>
    <span class="c1"># Interruptable API</span>
    <span class="c1">#</span>
    
<div class="viewcode-block" id="ActorUnit.handleEvent"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.handleEvent">[docs]</a>    <span class="k">def</span> <span class="nf">handleEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventParam</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Event handling routine.</span>

<span class="sd">        Can be registered with event emmitters to be called, e.g. on</span>
<span class="sd">        cueing events.</span>
<span class="sd">        </span>
<span class="sd">        :param Event eventParam: An Event instance to tell what happened.</span>
<span class="sd">        :return: None</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">eventParam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startCueing</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">eventParam</span> <span class="o">==</span> <span class="n">Event</span><span class="o">.</span><span class="n">cueStandard</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startCueing</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">eventParam</span> <span class="o">==</span> <span class="n">Event</span><span class="o">.</span><span class="n">cueStop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stopCueing</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>
    
    <span class="c1">#</span>
    <span class="c1"># Specific public API</span>
    <span class="c1">#</span>
    
<div class="viewcode-block" id="ActorUnit.setBLEDiscoveryTimeout"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.setBLEDiscoveryTimeout">[docs]</a>    <span class="k">def</span> <span class="nf">setBLEDiscoveryTimeout</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">timeOut</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the BLE discovery timeout.</span>

<span class="sd">        Discovery phase will definitely end, after the given time has elapsed.</span>
<span class="sd">        </span>
<span class="sd">        :param timeOut: The timeout, given in seconds.</span>
<span class="sd">        :type timeOut: int or float</span>
<span class="sd">        :return: An error code indicating either success or the reason of failure.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bleDiscoveryTimeout</span> <span class="o">=</span> <span class="n">timeOut</span>
        <span class="k">return</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span></div>
    
<div class="viewcode-block" id="ActorUnit.getBLEConnectionState"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.getBLEConnectionState">[docs]</a>    <span class="k">def</span> <span class="nf">getBLEConnectionState</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the current BLE connection state.</span>
<span class="sd">        </span>
<span class="sd">        :return: The current connection state.</span>
<span class="sd">        :rtype: ConnectionState</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span></div>

<div class="viewcode-block" id="ActorUnit.isCoupled"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.isCoupled">[docs]</a>    <span class="k">def</span> <span class="nf">isCoupled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tell the current coupling status of this instance.</span>
<span class="sd">        </span>
<span class="sd">        Informs the caller on whether or not the connection with the</span>
<span class="sd">        actuator unit has been established via BLE and is still intact.</span>
<span class="sd">        </span>
<span class="sd">        Returns :attr:`.ErrorCode.errOk` if the unit is coupled,</span>
<span class="sd">        :attr:`.ErrorCode.errUnavailable` if it is not coupled</span>
<span class="sd">        and any other value to indicate the reason, why this information</span>
<span class="sd">        could not be retrieved.</span>

<span class="sd">        :return: An error code.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errFailure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleLock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">==</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">connected</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errUnavailable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleLock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="ActorUnit.couple"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.couple">[docs]</a>    <span class="k">def</span> <span class="nf">couple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger the procedure to establish a BLE connection.</span>
<span class="sd">        </span>
<span class="sd">        Return quickly with a success-or-failure indicator for this</span>
<span class="sd">        triggering.</span>
<span class="sd">        Notice on the result of the coupling is given via subscription</span>
<span class="sd">        on the :attr:`Event.bleDiscovering` and</span>
<span class="sd">        :attr:`Event.bleConnected` event.</span>

<span class="sd">        :return: An error code indicating either success or the reason of failure.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">==</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bleWorker</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;AU coupling&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_couplingRoutine</span><span class="p">(),</span> <span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ret</span></div>
    
    
<div class="viewcode-block" id="ActorUnit.decouple"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.decouple">[docs]</a>    <span class="k">def</span> <span class="nf">decouple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger the procedure to close a BLE connection.</span>
<span class="sd">        </span>
<span class="sd">        Return quickly with a success-or-failure indicator for this</span>
<span class="sd">        triggering, i.e. gives :attr:`.ErrorCode.errOk`, if the procedure</span>
<span class="sd">        launched, and a failure e.g. when the AU is not coupled.</span>
<span class="sd">        Notice on the result of the decoupling is given via</span>
<span class="sd">        subscription to the :attr:`Event.bleDisconnected` event.</span>

<span class="sd">        :return: An error code indicating either success or the reason of failure.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">==</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">connected</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decouplingRoutine</span><span class="p">()</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errInadequate</span>
        <span class="k">return</span> <span class="n">ret</span></div>
    
<div class="viewcode-block" id="ActorUnit.startCueing"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.startCueing">[docs]</a>    <span class="k">def</span> <span class="nf">startCueing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Issue a start command to the actuator unit.</span>

<span class="sd">        Make the actor unit start cueing.</span>
<span class="sd">        </span>
<span class="sd">        :return: An error code indicating either success or the reason of failure.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">==</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">connected</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendRoutine</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdStart</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendRoutine</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdStart</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errUnavailable</span>
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="ActorUnit.stopCueing"><a class="viewcode-back" href="../../../philander.fastgait.html#philander.fastgait.actorunit.ActorUnit.stopCueing">[docs]</a>    <span class="k">def</span> <span class="nf">stopCueing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Issue a stop command to the actuator unit.</span>

<span class="sd">        :return: An error code indicating either success or the reason of failure.</span>
<span class="sd">        :rtype: ErrorCode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">==</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">connected</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendRoutine</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdStop</span> <span class="p">)</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendRoutine</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmdStop</span> <span class="p">)</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errOk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">errUnavailable</span>
        <span class="k">return</span> <span class="n">result</span></div>
    

    <span class="c1">#</span>
    <span class="c1"># Internal helper functions</span>
    <span class="c1">#</span>
    

    <span class="k">def</span> <span class="nf">_setState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newState</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleLock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">=</span> <span class="n">newState</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleLock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_emitState</span><span class="p">(</span> <span class="n">newState</span> <span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">_changeState</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">toState</span><span class="p">,</span> <span class="n">fromState</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleLock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fromState</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">!=</span> <span class="n">toState</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">==</span> <span class="n">fromState</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bleConnectionState</span> <span class="o">=</span> <span class="n">toState</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bleLock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_emitState</span><span class="p">(</span> <span class="n">toState</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>
        
        
    <span class="k">def</span> <span class="nf">_emitState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newState</span><span class="p">):</span>
        <span class="n">stateXevt</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span><span class="p">:</span>  <span class="n">Event</span><span class="o">.</span><span class="n">bleDisconnected</span><span class="p">,</span>
            <span class="n">ConnectionState</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>     <span class="n">Event</span><span class="o">.</span><span class="n">bleConnected</span><span class="p">,</span>
            <span class="n">ConnectionState</span><span class="o">.</span><span class="n">discovering</span><span class="p">:</span>   <span class="n">Event</span><span class="o">.</span><span class="n">bleDiscovering</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span> <span class="n">stateXevt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">newState</span><span class="p">,</span> <span class="n">Event</span><span class="o">.</span><span class="n">bleDisconnected</span> <span class="p">)</span> <span class="p">)</span>
        
        
    <span class="k">def</span> <span class="nf">_handleDisconnected</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">client</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setState</span><span class="p">(</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span> <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unsolicited disconnect: &#39;</span> <span class="o">+</span> <span class="n">client</span><span class="o">.</span><span class="n">address</span> <span class="p">)</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_couplingRoutine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Establish a connection with the first available actuator unit.</span>
<span class="sd">        </span>
<span class="sd">        Do the BlueTooth coupling.</span>
<span class="sd">        Returns nothing, but executes the bleDiscovering,</span>
<span class="sd">        bleConnected or bleDisconnected events, as a side-effect.</span>

<span class="sd">        :return: None</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Discovering</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changeState</span><span class="p">(</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">discovering</span> <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">devices</span> <span class="o">=</span> <span class="k">await</span> <span class="n">BleakScanner</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bleDiscoveryTimeout</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;UUIDs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ActorUnit</span><span class="o">.</span><span class="n">BLE_DEVICE_UUID</span><span class="p">]}</span> <span class="p">)</span>
                <span class="k">if</span> <span class="n">devices</span><span class="p">:</span>
                    <span class="c1"># Try to connect</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bleClient</span> <span class="o">=</span> <span class="n">BleakClient</span><span class="p">(</span> <span class="n">devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bleClient</span><span class="o">.</span><span class="n">set_disconnected_callback</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handleDisconnected</span> <span class="p">)</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bleClient</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                        <span class="n">svcColl</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bleClient</span><span class="o">.</span><span class="n">get_services</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bleChar</span> <span class="o">=</span> <span class="n">svcColl</span><span class="o">.</span><span class="n">get_characteristic</span><span class="p">(</span> <span class="n">ActorUnit</span><span class="o">.</span><span class="n">BLE_CHARACTERISTIC_UUID</span> <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_setState</span><span class="p">(</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">connected</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_setState</span><span class="p">(</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_setState</span><span class="p">(</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_couplingRoutine</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; caught &#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setState</span><span class="p">(</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span> <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_decouplingRoutine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close a BLE connection.</span>
<span class="sd">        </span>
<span class="sd">        Returns nothing, but emits the :attr:`.Event.bleDisconnected`</span>
<span class="sd">        event, as a side-effect.</span>

<span class="sd">        :return: None</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bleClient</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bleClient</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decouplingRoutine</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; caught &#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setState</span><span class="p">(</span> <span class="n">ConnectionState</span><span class="o">.</span><span class="n">disconnected</span> <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">_sendRoutine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmdData</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">bleClient</span><span class="o">.</span><span class="n">write_gatt_char</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">bleChar</span><span class="p">,</span> <span class="n">cmdData</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">except</span> <span class="n">BleakDBusError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span> <span class="c1"># In Progress</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendRoutine</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; caught &#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">err</span><span class="o">.</span><span class="n">dbus_error_details</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sendRoutine</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; caught &#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_bleWorker</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">routine</span> <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span> <span class="n">routine</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_evtLoop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span> <span class="n">routine</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">philander</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">philander</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, Oliver Maye.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
    </div>

    

    
  </body>
</html>