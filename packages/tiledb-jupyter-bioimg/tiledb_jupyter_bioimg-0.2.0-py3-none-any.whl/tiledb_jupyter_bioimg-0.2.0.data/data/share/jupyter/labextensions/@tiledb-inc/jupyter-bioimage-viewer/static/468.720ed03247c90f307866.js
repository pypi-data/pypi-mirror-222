(()=>{var e,t,r={6567:(e,t,r)=>{"use strict";var a=r(3578),n=r.n(a),o=r(4551),s=r(9757),l=r(8399);const i={int8:{bytes:Int8Array.BYTES_PER_ELEMENT,format:s.Z.RED_INTEGER,internalFormat:s.Z.R8I,type:s.Z.BYTE,filtering:s.Z.NEAREST,samplerType:"isampler2DArray",create:function(e){return new Int8Array(e)}},uint8:{bytes:Uint8Array.BYTES_PER_ELEMENT,format:s.Z.RED_INTEGER,internalFormat:s.Z.R8UI,type:s.Z.UNSIGNED_BYTE,filtering:s.Z.NEAREST,samplerType:"usampler2DArray",create:function(e){return new Uint8Array(e)}},int16:{bytes:Int16Array.BYTES_PER_ELEMENT,format:s.Z.RED_INTEGER,internalFormat:s.Z.R16I,type:s.Z.SHORT,filtering:s.Z.NEAREST,samplerType:"isampler2DArray",create:function(e){return new Int16Array(e)}},uint16:{bytes:Uint16Array.BYTES_PER_ELEMENT,format:s.Z.RED_INTEGER,internalFormat:s.Z.R16UI,type:s.Z.UNSIGNED_SHORT,filtering:s.Z.NEAREST,samplerType:"usampler2DArray",create:function(e){return new Uint16Array(e)}},float16:{bytes:Float32Array.BYTES_PER_ELEMENT,format:s.Z.RED,internalFormat:s.Z.R16F,type:s.Z.FLOAT,filtering:s.Z.NEAREST,samplerType:"sampler2DArray",create:function(e){return new Float32Array(e)}},float32:{bytes:Float32Array.BYTES_PER_ELEMENT,format:s.Z.RED,internalFormat:s.Z.R32F,type:s.Z.FLOAT,filtering:s.Z.NEAREST,samplerType:"sampler2DArray",create:function(e){return new Float32Array(e)}}};class c{constructor(e,t){this.baseAxes=e,this.targetAxes=t,this.permutationMatrix=new Array(e.length);for(let e=0;e<this.baseAxes.length;++e){const t=this.targetAxes.indexOf(this.baseAxes[e]);this.permutationMatrix[e]=t}}reshape(e){const t=new Array(this.baseAxes.length);for(let r=0;r<this.baseAxes.length;++r)t[this.targetAxes.indexOf(this.baseAxes[r])]=e[r];return t}}function f(e){if(0===e.length)throw new RangeError("Input array is empty.");if(e.length%2==1)throw new RangeError("Input array should have an even number of elements.");if(2===e.length)return[e,e[1]-e[0]+1];const t=[];let r=0;for(let a=0;a<e.length;a+=2)t.push([e[a],e[a+1]]),r+=e[a+1]-e[a]+1;return[t,r]}function u(...e){const t=[],r=e.length-1;return function a(n,o){for(let s=0,l=e[o].length;s<l;s++){const l=n.slice(0);l.push(e[o][s]),o===r?t.push(l):a(l,o+1)}}([],0),t}function h(e){let t=1;const r=[];if(0===e.length)return r;for(let a=1;a<=e.length;a++)a===e.length||e[a]-e[a-1]!=1?(1===t?r.push([e[a-t],e[a-t]]):r.push([e[a-t],e[a-1]]),t=1):t++;return r}const p="TILEDB_BIOIMAGE_CACHE";let d=1;const g=async e=>{const t=await(0,l.X3)(p);return t.objectStoreNames.contains(e+"_1")?t:(t.close(),d=t.version+1,(0,l.X3)(p,d,{upgrade(t){for(let r=0;r<1;++r)t.objectStoreNames.contains(e+"_"+r)&&t.deleteObjectStore(e+"_"+r);t.createObjectStore(e+"_1",{autoIncrement:!0}).createIndex("timestamp","__timestamp")}}))},y=async(e,t)=>{const r=await g(e),a=await r.get(e+"_1",t);return r.close(),a},m=async(e,t,r)=>{const a=await g(e),n=Date.now();await a.put(e+"_1",Object.assign(r,{__timestamp:n}),t),a.close()};self.onmessage=async function(e){const t={apiKey:e.data.token,basePath:e.data.basePath},r=new(n())(t),a=e.data.levelRecord.dimensions[e.data.levelRecord.axes.indexOf("X")],s=e.data.levelRecord.dimensions[e.data.levelRecord.axes.indexOf("Y")],l=e.data.levelRecord.downsample,p=e.data.index.x,d=e.data.index.y,g=e.data.tileSize,E=e.data.attribute.type.toLowerCase(),b=e.data.dimensions.length>0?"_"+e.data.dimensions.map((e=>e.value)).join("_"):"",A=e.data.levelRecord.arrayAxes.map((t=>e.data.levelRecord.axesMapping.get(t))).flat();-1===A.indexOf("C")&&A.push("C");const R=e.data.levelRecord.axesMapping,_=new c(A,A.filter((e=>!["C","Y","X"].includes(e))).concat(["C","Y","X"])),v=new Array(_.baseAxes.length);for(let e=0;e<_.baseAxes.length;++e){const t=_.baseAxes[e];v[e]="X"===t||"Y"===t?l:1}const w=new Map,x=[];for(let t=0;t<=e.data.channelRanges.length;t+=2)for(let r=e.data.channelRanges[t];r<=e.data.channelRanges[t+1];++r){const t=await y(`${e.data.levelRecord.id}_${g}`,`${e.data.attribute.name}_${r}${b}_${e.data.levelRecord.zoomLevel}_${p}_${d}`);t?w.set(r,t):x.push(r)}const T=new Map;T.set("Y",[d*g*l,Math.min((d+1)*g*l,s)-1]),T.set("X",[p*g*l,Math.min((p+1)*g*l,a)-1]);for(const t of e.data.dimensions)T.set(t.name,[t.value,t.value]);const S=~~((T.get("X")[1]-T.get("X")[0]+1)/l),O=~~((T.get("Y")[1]-T.get("Y")[0]+1)/l);if(T.get("X")[1]=T.get("X")[0]+S*l-1,T.get("Y")[1]=T.get("Y")[0]+O*l-1,0!==x.length){const t=[];for(const[e,r]of x.entries())0===t.length?t.push(r):r-x[e-1]!=1&&t.push(x[e-1],r);t.push(x.at(-1)),T.set("C",t);const[a,n]=function(e,t,r,a,n,o,s){const l=[];let i=1;for(const[c,p]of r.entries()){const d=a.get(p);if(1===d.length){const[e,t]=f(n.get(d[0]).map((e=>e+s[c])));l.push(e),i*=t}else{const a=[];for(const r of d)a.push(e[t.indexOf(r)]);const f=new Array(d.length).fill(1);for(let e=0;e<a.length;++e)for(let t=e+1;t<a.length;++t)f[e]*=a[t];const g=[],y=[];for(const e of d){const t=[],r=[],a=n.get(e);for(let e=0;e<a.length;e+=2)t.push(a[e+1]-a[e]+1),r.push(a[e]);g.push(t),y.push(r)}const m=u(...g),E=u(...y),b=[],A=[];for(const e of E){let t=0;for(let r=0;r<e.length;++r)t+=e[r]*f[r];b.push(t)}for(const e of m){const t=new Array(d.length+1).fill(Number.MAX_SAFE_INTEGER,0,1).fill(1,1);for(let r=0;r<e.length;++r)for(let a=r+1;a<e.length;++a)t[r+1]*=e[a];A.push(t)}let R=0;const _=new Array(d.length),v=[],w=o[r.indexOf(p)];for(let e=0;e<m.length;++e){const t=m[e].reduce(((e,t)=>e*t),1);for(let r=0;r<t;++r){R=b[e];for(let t=0;t<A[e].length-1;++t)_[t]=~~(r%A[e][t]/A[e][t+1]),R+=_[t]*f[t];if(R>=w)return console.error("OOB"),[[],0];v.push(R+s[c])}}v.sort(((e,t)=>e-t)),l.push(h(v)),i*=v.length}}return[l,i]}(e.data.levelRecord.dimensions,e.data.levelRecord.axes,e.data.levelRecord.arrayAxes,R,T,e.data.levelRecord.arrayExtends,e.data.levelRecord.arrayOffset);if(0===a.length)return;const s={layout:o.Layout.RowMajor,ranges:a,bufferSize:n*i[E].bytes,attributes:[e.data.attribute.name],returnRawBuffers:!0},l=r.query.ReadQuery(e.data.namespace,e.data.levelRecord.id,s);let c=0;const y=i[E].create(n);for await(const t of l){const r=i[E].create(t[e.data.attribute.name]);y.set(r,c),c+=r.length}const N=[];for(const e of A)switch(e){case"X":case"Y":N.push(T.get(e)[1]-T.get(e)[0]+1);break;case"C":N.push(x.length);break;default:N.push(1)}const M=function(e,t,r,a){if(t.baseAxes.toString()===t.targetAxes.toString()&&1===Math.max(...a))return e;const n=t.reshape(r),o=t.reshape(a);let s=1;for(let e=0;e<n.length;++e)n[e]=~~(n[e]/o[e]),s*=n[e];const l=new e.constructor(s),i=new Array(t.baseAxes.length+1).fill(Number.MAX_SAFE_INTEGER,0,1).fill(1,1),c=new Array(t.baseAxes.length).fill(1);for(let e=0;e<r.length;++e)for(let t=e+1;t<r.length;++t)i[e+1]*=r[t],c[e]*=n[t];let f=0;const u=a.reduce(((e,t)=>e*t),1),h=new Array(t.baseAxes.length);for(let r=0;r<e.length;++r){f=0;for(let e=0;e<i.length-1;++e)h[e]=~~(r%i[e]/i[e+1]),f+=~~(h[e]/o[t.permutationMatrix[e]])*c[t.permutationMatrix[e]];l[f]+=e[r]/u}return l}(y,_,N,v);for(const[t,r]of x.entries()){const a=M.slice(t*S*O,(t+1)*S*O);w.set(r,a),await m(`${e.data.levelRecord.id}_${g}`,`${e.data.attribute.name}_${r}${b}_${e.data.levelRecord.zoomLevel}_${p}_${d}`,a)}}const N=i[E].create(w.size*S*O);let M=0;for(let t=0;t<=e.data.channelRanges.length;t+=2)for(let r=e.data.channelRanges[t];r<=e.data.channelRanges[t+1];++r)N.set(w.get(r),M*S*O),++M;self.postMessage({data:N,width:S,height:O,channels:w.size},[N.buffer])}},8291:()=>{},4447:()=>{}},a={};function n(e){var t=a[e];if(void 0!==t)return t.exports;var o=a[e]={exports:{}};return r[e].call(o.exports,o,o.exports,n),o.exports}n.m=r,n.c=a,n.x=()=>{var e=n.O(void 0,[995],(()=>n(6567)));return n.O(e)},e=[],n.O=(t,r,a,o)=>{if(!r){var s=1/0;for(f=0;f<e.length;f++){for(var[r,a,o]=e[f],l=!0,i=0;i<r.length;i++)(!1&o||s>=o)&&Object.keys(n.O).every((e=>n.O[e](r[i])))?r.splice(i--,1):(l=!1,o<s&&(s=o));if(l){e.splice(f--,1);var c=a();void 0!==c&&(t=c)}}return t}o=o||0;for(var f=e.length;f>0&&e[f-1][2]>o;f--)e[f]=e[f-1];e[f]=[r,a,o]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[])),n.u=e=>e+".7e5a9c38e396a47c7d4a.js?v=7e5a9c38e396a47c7d4a",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{n.S={};var e={},t={};n.I=(r,a)=>{a||(a=[]);var o=t[r];if(o||(o=t[r]={}),!(a.indexOf(o)>=0)){if(a.push(o),e[r])return e[r];n.o(n.S,r)||(n.S[r]={}),n.S[r];var s=[];return e[r]=s.length?Promise.all(s).then((()=>e[r]=1)):1}}})(),(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var a=r.length-1;a>-1&&!e;)e=r[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={468:1};n.f.i=(t,r)=>{e[t]||importScripts(n.p+n.u(t))};var t=self.webpackChunk_tiledb_inc_jupyter_bioimage_viewer=self.webpackChunk_tiledb_inc_jupyter_bioimage_viewer||[],r=t.push.bind(t);t.push=t=>{var[a,o,s]=t;for(var l in o)n.o(o,l)&&(n.m[l]=o[l]);for(s&&s(n);a.length;)e[a.pop()]=1;r(t)}})(),t=n.x,n.x=()=>n.e(995).then(t),n.x()})();