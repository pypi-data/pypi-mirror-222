var h=Object.defineProperty,d=(o,t,e)=>t in o?h(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,l=(o,t,e)=>(d(o,typeof t!="symbol"?t+"":t,e),e);class r{constructor(t,e,s){l(this,"templatePrefix","__prefix__"),l(this,"_namePattern"),this.formset=t,this.rootEl=e,this.options=s,this._namePattern=new RegExp(`^${s.prefix}-([^-]+)-(.+)$`),this.isTemplate=this.getFields()[0].name.match(this._namePattern)[1]===this.templatePrefix,this.deleteEl=this.getDeleteEl(),this.render()}getFields(){return Array.from(this.rootEl.querySelectorAll("input,select,textarea"))}getValues(){return this.getFields().reduce((t,e,s)=>(t[e.name.match(this._namePattern)[2]]=e.value,t),{})}hasContent(t){return this.getFields().some((e,s)=>{const i=e.name.match(this._namePattern)[2];if(i===this.options.pkFieldName){if(e.value)return!0}else return e.value!==t[i]})}getDeleteEl(){var t;let e=this.rootEl.querySelector('[name$="-DELETE"]');if(e)return e.addEventListener("click",s=>{(this.isDeleted&&this.formset.atMin&&!this.options.allowDeleteAtMin||!this.isDeleted&&this.formset.atMax&&!this.options.allowAddAtMax)&&(s.preventDefault(),s.stopPropagation())}),e.addEventListener("change",()=>{e.checked?this.deleted():this.undeleted()}),(t=e.closest(this.options.deleteConClosest))==null||t.classList.add(this.options.deleteConCss),e}get isDeleted(){var t;return((t=this.deleteEl)==null?void 0:t.checked)===!0}deleted(){this.formset.deactivateForm(this)}undeleted(){this.formset.activateForm(this)}render(){this.rootEl.classList.toggle(this.options.formDeletedCss,this.isDeleted)}destroy(){this.rootEl.remove(),this.formset.destroyedForm(this),this.formset=null}}class a{constructor(t,e){l(this,"formClass",r),this.rootEl=t;let s=e.prefix||t.getAttribute(e.prefixAttr);if(!s)throw this._e("Formset prefix not found");this.options=e={...e,prefix:s},this.totalFormsEl=document.getElementById(`id_${s}-TOTAL_FORMS`),this.initialFormsEl=document.getElementById(`id_${s}-INITIAL_FORMS`),this.numFormsMin=parseInt(document.getElementById(`id_${s}-MIN_NUM_FORMS`).value,10),this.numFormsMax=parseInt(document.getElementById(`id_${s}-MAX_NUM_FORMS`).value,10),this.addEl=this.getAddEl(),this.collectForms(),this.rootEl.classList.add(this.options.formsetActiveCss),this.render(),this.event("formset:init")}_e(t){return new Error(t,{cause:this.rootEl})}collectForms(){this.forms=Array.from(this.rootEl.querySelectorAll(this.options.formSelector),s=>new this.formClass(this,s,this.options));let t=this.forms.findIndex(s=>s.isTemplate);if(t>-1)this.template=this.forms.splice(t,1)[0];else throw this._e(`Formset ${this.options.prefix} template form not found`);this.numForms=this.forms.length;const e=parseInt(this.initialFormsEl.value,10);if(this.numForms>e){const s=this.template.getValues();this.forms.slice().reverse().forEach(i=>{this.atMin||i.hasContent(s)||i.destroy()})}this._nextId=this.numForms}getAddEl(){let t=document.createElement("button");return t.innerHTML=this.options.addButtonLabel,t.type="button",t.className=this.options.addButtonCss,this.rootEl.appendChild(t),t.onclick=()=>{this.addForm()},t}addForm(){if(this.atMax&&!this.options.allowAddAtMax)return;let t=this._nextId++,e=this.createForm(t),s=this.insertForm(t,e);this.activateForm(s)}render(){this.forms.forEach(t=>{t.render()}),this.rootEl.classList.toggle(this.options.formsetAtMinCss,this.atMin),this.rootEl.classList.toggle(this.options.formsetAtMaxCss,this.atMax)}get numForms(){return parseInt(this.totalFormsEl.value,10)}set numForms(t){this.totalFormsEl.value=t}createForm(t){let e=this.template.rootEl.innerHTML.replace(/__prefix__/g,t),s=this.template.rootEl.cloneNode();return s.removeAttribute("style"),s.classList.add(this.options.formAddedCss),s.innerHTML=e,s}insertForm(t,e){let s=this.template;this.forms.length>0&&(s=this.forms[this.forms.length-1]);let i=s.rootEl;i.parentNode.insertBefore(e,i.nextSibling);let n=new r(this,e,this.options);return this.forms.push(n),this.event("formset:form-add",n),n}event(t,e){const s={formset:this,form:e};this.rootEl.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:s}))}activateForm(t){this.numForms+=1,this.render(),this.event("formset:form-activate",t)}deactivateForm(t){this.numForms-=1,this.render(),this.event("formset:form-deactivate",t)}destroyedForm(t){this.forms.splice(this.forms.indexOf(t),1),this.numForms-=1,this.render(),this.event("formset:form-destroy",t)}get atMax(){return this.numForms>=this.numFormsMax}get atMin(){return this.numForms<=this.numFormsMin}}const m={formsetSelector:"[data-formset]",formsetClass:a,prefix:null,prefixAttr:"data-formset",formSelector:":scope > fieldset",formClass:r,pkFieldName:"id",formsetActiveCss:"formset-active",formAddedCss:"added",formDeletedCss:"deleted",addButtonLabel:"Add",addButtonCss:"formset-add",deleteConClosest:"p,div,tr,li",deleteConCss:"formset-delete",formsetAtMinCss:"formset-at-min",allowDeleteAtMin:!1,formsetAtMaxCss:"formset-at-max",allowAddAtMax:!1};function f(o={},t=null){o={...m,...o},t=t||o.formsetSelector;let e;return t instanceof Array?e=t:t instanceof HTMLElement?e=[t]:(t&&!(t instanceof NodeList)&&(t=document.querySelectorAll(t)),e=Array.from(t)),e.map(s=>new o.formsetClass(s,o))}export{r as Form,a as Formset,m as defaultOptions,f as init};
