(function(r,o){typeof exports=="object"&&typeof module<"u"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(r=typeof globalThis<"u"?globalThis:r||self,o(r.formset={}))})(this,function(r){"use strict";var u=Object.defineProperty;var c=(r,o,n)=>o in r?u(r,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[o]=n;var a=(r,o,n)=>(c(r,typeof o!="symbol"?o+"":o,n),n);class o{constructor(t,s,e){a(this,"templatePrefix","__prefix__");a(this,"_namePattern");this.formset=t,this.rootEl=s,this.options=e,this._namePattern=new RegExp(`^${e.prefix}-([^-]+)-(.+)$`),this.isTemplate=this.getFields()[0].name.match(this._namePattern)[1]===this.templatePrefix,this.deleteEl=this.getDeleteEl(),this.render()}getFields(){return Array.from(this.rootEl.querySelectorAll("input,select,textarea"))}getValues(){return this.getFields().reduce((s,e,i)=>(s[e.name.match(this._namePattern)[2]]=e.value,s),{})}hasContent(t){return this.getFields().some((i,m)=>{const h=i.name.match(this._namePattern)[2];if(h===this.options.pkFieldName){if(i.value)return!0}else return i.value!==t[h]})}getDeleteEl(){var s;let t=this.rootEl.querySelector('[name$="-DELETE"]');if(t)return t.addEventListener("click",e=>{(this.isDeleted&&this.formset.atMin&&!this.options.allowDeleteAtMin||!this.isDeleted&&this.formset.atMax&&!this.options.allowAddAtMax)&&(e.preventDefault(),e.stopPropagation())}),t.addEventListener("change",()=>{t.checked?this.deleted():this.undeleted()}),(s=t.closest(this.options.deleteConClosest))==null||s.classList.add(this.options.deleteConCss),t}get isDeleted(){var t;return((t=this.deleteEl)==null?void 0:t.checked)===!0}deleted(){this.formset.deactivateForm(this)}undeleted(){this.formset.activateForm(this)}render(){this.rootEl.classList.toggle(this.options.formDeletedCss,this.isDeleted)}destroy(){this.rootEl.remove(),this.formset.destroyedForm(this),this.formset=null}}class n{constructor(t,s){a(this,"formClass",o);this.rootEl=t;let e=s.prefix||t.getAttribute(s.prefixAttr);if(!e)throw this._e("Formset prefix not found");this.options=s={...s,prefix:e},this.totalFormsEl=document.getElementById(`id_${e}-TOTAL_FORMS`),this.initialFormsEl=document.getElementById(`id_${e}-INITIAL_FORMS`),this.numFormsMin=parseInt(document.getElementById(`id_${e}-MIN_NUM_FORMS`).value,10),this.numFormsMax=parseInt(document.getElementById(`id_${e}-MAX_NUM_FORMS`).value,10),this.addEl=this.getAddEl(),this.collectForms(),this.rootEl.classList.add(this.options.formsetActiveCss),this.render(),this.event("formset:init")}_e(t){return new Error(t,{cause:this.rootEl})}collectForms(){this.forms=Array.from(this.rootEl.querySelectorAll(this.options.formSelector),e=>new this.formClass(this,e,this.options));let t=this.forms.findIndex(e=>e.isTemplate);if(t>-1)this.template=this.forms.splice(t,1)[0];else throw this._e(`Formset ${this.options.prefix} template form not found`);this.numForms=this.forms.length;const s=parseInt(this.initialFormsEl.value,10);if(this.numForms>s){const e=this.template.getValues();this.forms.slice().reverse().forEach(i=>{this.atMin||i.hasContent(e)||i.destroy()})}this._nextId=this.numForms}getAddEl(){let t=document.createElement("button");return t.innerHTML=this.options.addButtonLabel,t.type="button",t.className=this.options.addButtonCss,this.rootEl.appendChild(t),t.onclick=()=>{this.addForm()},t}addForm(){if(this.atMax&&!this.options.allowAddAtMax)return;let t=this._nextId++,s=this.createForm(t),e=this.insertForm(t,s);this.activateForm(e)}render(){this.forms.forEach(t=>{t.render()}),this.rootEl.classList.toggle(this.options.formsetAtMinCss,this.atMin),this.rootEl.classList.toggle(this.options.formsetAtMaxCss,this.atMax)}get numForms(){return parseInt(this.totalFormsEl.value,10)}set numForms(t){this.totalFormsEl.value=t}createForm(t){let e=this.template.rootEl.innerHTML.replace(/__prefix__/g,t),i=this.template.rootEl.cloneNode();return i.removeAttribute("style"),i.classList.add(this.options.formAddedCss),i.innerHTML=e,i}insertForm(t,s){let e=this.template;this.forms.length>0&&(e=this.forms[this.forms.length-1]);let i=e.rootEl;i.parentNode.insertBefore(s,i.nextSibling);let m=new o(this,s,this.options);return this.forms.push(m),this.event("formset:form-add",m),m}event(t,s){const e={formset:this,form:s};this.rootEl.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:e}))}activateForm(t){this.numForms+=1,this.render(),this.event("formset:form-activate",t)}deactivateForm(t){this.numForms-=1,this.render(),this.event("formset:form-deactivate",t)}destroyedForm(t){this.forms.splice(this.forms.indexOf(t),1),this.numForms-=1,this.render(),this.event("formset:form-destroy",t)}get atMax(){return this.numForms>=this.numFormsMax}get atMin(){return this.numForms<=this.numFormsMin}}const d={formsetSelector:"[data-formset]",formsetClass:n,prefix:null,prefixAttr:"data-formset",formSelector:":scope > fieldset",formClass:o,pkFieldName:"id",formsetActiveCss:"formset-active",formAddedCss:"added",formDeletedCss:"deleted",addButtonLabel:"Add",addButtonCss:"formset-add",deleteConClosest:"p,div,tr,li",deleteConCss:"formset-delete",formsetAtMinCss:"formset-at-min",allowDeleteAtMin:!1,formsetAtMaxCss:"formset-at-max",allowAddAtMax:!1};function f(l={},t=null){l={...d,...l},t=t||l.formsetSelector;let s;return t instanceof Array?s=t:t instanceof HTMLElement?s=[t]:(t&&!(t instanceof NodeList)&&(t=document.querySelectorAll(t)),s=Array.from(t)),s.map(i=>new l.formsetClass(i,l))}r.Form=o,r.Formset=n,r.defaultOptions=d,r.init=f,Object.defineProperty(r,Symbol.toStringTag,{value:"Module"})});
